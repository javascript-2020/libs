

<editor-root>

      <template shadowrootmode=open>
      
            <style>

                  #root {display:flex;flex-direction:column;height:100%;font-family:arial}
                  
                  #hdr {display:flex;position:relative;align-items:center;height:26px;}
                  
                  #menu-icon {width:15px;height:26px;border:1px solid gray;padding:2px;background:buttonface;margin-right:10px;box-sizing:border-box;cursor:pointer;border-radius:3px;
                              content:url(data:image/jpeg;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAMAAAC7IEhfAAAAt1BMVEVHcEwbmPYcgfMchvQbsfkay/wbtvkbnfccefMayfwbmfYch/QchvQbtfkbmfYa1P0ddfIcivQcl/Ycj/Ubp/gcmfYdbPEbrvkazPwcmfYbqfgayfwayPwbv/sbvvobsvkazPwbqvga0fwbvPobtvocjvUbofcbpvccfPMcgPMcgvMdafAdbfEckfUbtvka0PwcfPIaxvsbwfsbvPodb/EcnPYclvYckfUbpvccjPQdd/IbofcbrPiPy8D0AAAAMHRSTlMAA/79/v7+5ycVZ3Y3h0xhu9jp8kFeF9OkVfQOrZi+Mh1z/iUJQ+/dx4fOYq7hybzs5xU1AAABIklEQVQ4y+2Ux3aDMBBFpTR6M92AwYB7S6EG/v+7MsJJnBBKVsnGdwHozT1HQgxC6MrfEkiSM+Y4khSgUxhazLDHWGF4QveAO2gyLnGQ9QS4wcDaXGJYiPGegVnU50UzUvdgTsd7AfrMaEaqXvO+sfAAHP0uzz+SmhCfR7FwB5gdpm+SyoeHEJ5P67o2tbanmRBP5/iSgFkUxaplaisIv3kAu6yqihK/RiIF0ZJtT6NTaZpS9iWwm0D/uXB7kmXZ5LOgN0O7ayvEQ57nKtssCbMqDA5i9+YulLIsVQ5MzKnwqCz6Phev3AIcxhy5K3x/A/DbG2CzIdctP9RS9PrxnTU92KOYll8bZHqs7Wk5AcY9hIx9kuyN3/xuxm5nXA+df+cNJSAgjMbiFSoAAAAASUVORK5CYII=)
                              }
                  .menu {position:absolute;left:0;top:35px}
                  
                  #filename-root {/*display:flex;align-items:center*/ margin-right:20px}
                  #filename-icon {width:20px;height:20px;margin-right:5px;box-sizing:border-box;vertical-align:middle;
                                  content:url(data:image/jpeg;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAMAAAC7IEhfAAAAP1BMVEVHcEwVFRUICAgkJCQMDAwLCwsNDQ1QUFAICAgrKysQEBAVFRUHBwcLCwsZGRkKCgoHBwfd3d0ICAgkJCQEBATHNF52AAAAFXRSTlMAQ9IblZl1BbQOXDbHiiWj1wG2H/ZbTuAhAAAA5klEQVQ4y72V2w6DIAxAKQjIRRT1/791gkg226mJc+elSE5qqYCMPQV0zY4uUF7grdwxc0cl5NNuxvjBO0oUuxnhbUPkxKLxYCQ2yYzMSPT2LMbCmpFbRphJtH0B0ozu/TJsZy+QCF1hTTKpNG4GOKlxK5XfEKNOsBIzkRTt2C5AVDkmRkuKTiUCA1Vx92q8LDqFcAeLeefLYt7actyeyzUKVwnM5ChIUQ2VJgJPUZGiCZXtwdyrURuEpvvoEXQfg0XQX0b/fFN84PIxgwuiTAfX/mXjTtdE4iJdaXk4u5rLBQ2P/Q1eGdEQZZzIbegAAAAASUVORK5CYII=)
                                  }
                  #filename-save {width:20px;height:20px;margin-right:5px;box-sizing:border-box;vertical-align:middle;
                                  content:url(data:image/jpeg;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoBAMAAAB+0KVeAAAAKlBMVEX/pQD/////qhH/pAD/rhr/zHH/yGT/wlP//vz/8dn/tjD/+u//6MD/2ZUL9bZAAAAA30lEQVQoz2OQvuWihARUMgUFBRlamRkYlqXBQLoy10Sg4CUGBisgDQLSu3dLXGBeAxRczMBg3ggR3LZqaeMhBquDggzOCMFdxuZAQWYfQQYHuKDELgOQINA0JEFBqCDzSiwqGdiwqGRgYlDAVIksSIpKYyyC28E+ggoi/L5D8AJMkGFZKAyEKcAFjRGAAS6IBsCCzMbGKGpBgkwqLshAASzoOxMFHDEACjJXCKKANmyCYkNI0IEGgs7YBBdjCpowXGBejSq43YCVYSszV1ooEkgrMMhmkL6lhAIUlJZuBAAfSYTf2T2EkwAAAABJRU5ErkJggg==)
                                }
                  #filename {margin:5px 0;flex:1}

                  #spc {flex:1}
                  
                  button {height:26px;padding:0 5px;margin-right:5px;font-size:16px;cursor:pointer}
                  #paste {margin-right:10px}
                  
                  #info {display:flex;align-items:center;margin-right:20px}
                  #sep {margin:0 10px}
                  
                  #row,#col {width:40px;height:26px;text-align:center;box-sizing:border-box;font-size:16px}
                  #row {margin-right:5px}
                  #col {margin-right:10px}
                  
                  #top,#bottom {width:20px;height:20px;border:1px solid dimgray;padding:2px;border-radius:3px;cursor:pointer;}
                  #top {margin-right:5px;
                          content:url(data:image/jpeg;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAsCAMAAAAgsQpJAAAAP1BMVEVHcExEpvVCpvZLpu5Mpexare1EpfNBpvRFpvNGpvNSp+xuq9xHpvFiq+RHpvFMpu5CpvRTp+mrtLlQp+xBpvbrVekHAAAAFHRSTlMA9P1dHz2e3sy7KgR3CoxQ6xUBM2Gq4CQAAAEASURBVDjL7dVJEoMgEAVQBILM8/3PmsQWFQewKskuf+PmFWh3gwj9JCY9GkmmOMr80IgXEly0uR3MFGwsOjDzMEHFelDMbyk5boY/ytcERxpx9NOqqhDMneITxrnQ3e0ow1AR13FLTb2755oy0qpHnlxBuevllZSHnnsSew5fS8nnSZmefq7ScJCLS9MsjdKeywQOc4kAUlOkVkeXX65AdCaLmw5HgUiBxKus3AqR0kMlaXEwMSuMBmQeoJsOb90GLmtmFldYXAWLtHBixNbVEOSY5uHSTAd0Dl8bWpuW+drWdA8v84ffge+LGo+hD917DKzqw0gEt+HebyfED67XJz8tJngV1cZbAAAAAElFTkSuQmCC)
                      }
                  #bottom {content:url(data:image/jpeg;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAsBAMAAADlQedIAAAAMFBMVEVHcExDpvVLpu5CpvZNpexYrO1EpfNmq+JBpvRFpvNGpvNSp+xHpvGrtLlHpvFBpvabmoDrAAAAD3RSTlMA81r9HDqeBt7Muyp3AYxdzYCkAAABLElEQVQoz2NgwAvYfTHFeLXmOWAIMsn/f44hyPf/cwuGINv//4Nc8DoWQZZjR5AFmd4FAEmv/78cEILsB/+3Ainl//+XIARr5P//gwiClEIEgQr/f7vAwOD5H6wULMgLVPhfCKiSdT5Q6QaIIEih4XGQfTuBSldDBOvs/3+WKWCAKv25ASTI/vj//4/HIS4FKv08GyQIVPgfopCB4TZIadj//90ghbowT4FMnfn/vxhQodAFmCD3eqDo/89AMUNdhP93/YcChEKYUqBCBeTk4QVViBLEV8BKfyigBrwXpkKg0mSgWxXQ46goc9YRzLR4xZ2BEHBSQgEqYIdPNkYBlqDYLPuPBpYDBavQBacABe+hiX1OB6WQREEUILUBZFNpKAoIh4bRXSRwAZfLAT6sAtz4b+DtAAAAAElFTkSuQmCC)
                      }
            
                  #editor {flex:1}
                  
            </style>
            
            <div id=root>
            
                  <div id=hdr>
                  
                        <img id=menu-icon>
            
                        <div class=menu style='display:none'>
                              <div id=trim class=menu-opt>trim</div>      
                        </div>
                  
                        <div id=filename-root>
                              <img id=filename-icon>
                              <img id=filename-save style='display:none'>
                              <span id=filename>filename</span>
                        </div>
                        
                        <div id=info>
                              <div id=lines>0</div>
                              <div id=sep>/</div>
                              <div id=chars>0</div>
                        </div>
                        
                        <span id=spc></span>
                        
                        <input id=row value=0>
                        <input id=col value=0>
                        
                        <button id=clear>clear</button>
                        <button id=copy>copy</button>
                        <button id=paste>paste</button>
                                                
                        <img id=top>
                        <img id=bottom>
                        
                  </div>
                  
                  <div id=editor></div>
                  
            </div>
            
      </template>
      
      <script>
      
            
            function editor(){
                                                                                  true && console.log('editor');
              var obj   = {};

                  load    = load();
                  
                  var editor;
                  
                  var root;
                  var shadow;
                  
                  var hdr;
                  var row;
                  var col;
                  
                  var deficon;
                  
                  var kd    = {};
                  var btn   = {};

                  
                  function load(){

                        var resolve,load    = new Promise(res=>resolve=res);
                        
                        var script      = document.createElement('script');
                        script.src      = 'https://cdn.jsdelivr.net/npm/ace-builds@1.37.0/src-min-noconflict/ace.js';
                        script.onload   = resolve;
                        document.head.append(script);
                        
                        return load;
                        
                  }//load
                  
                  
                  obj.initdom=async function(rootnode,mode='javascript'){
                  
                        if(rootnode){
                              root                        = $(rootnode,'editor-root');
                        }else{
                              root                        = $.full('editor-root');
                        }
                        shadow                            = root.shadowRoot;

                        menumod.add.style(shadow);
                        var style                         = $(shadow,'style');


                        hdr                               = $(shadow,'#hdr');
                        
                        var card                          = $(shadow,'.menu');
                        $(shadow,'#menu-icon').onclick    = menumod.click(card,false,false,menu);
                        
                        deficon                           = $(hdr,'#filename-icon').src;
                        
                        $(shadow,'#clear').onclick        = btn.clear;
                        $(shadow,'#copy').onclick         = btn.copy;
                        $(shadow,'#paste').onclick        = btn.paste;
                        
                        row                               = $(hdr,'#row');
                        row.onkeydown                     = kd.row;
                        row.onmousedown                   = e=>e.target.select();
                        col                               = $(hdr,'#col');
                        col.onkeydown                     = kd.col;
                        col.onmousedown                   = e=>e.target.select();
                        
                        $(hdr,'#top').onclick             = btn.top;
                        $(hdr,'#bottom').onclick          = btn.bottom;


                        await setup(shadow,mode);

console.log('editor.initdom.complete');
                        
                  }//initdom


                  async function setup(root,mode='javascript'){
          
                        await load;

                        import_style();

                        switch(mode){
                        
                          case 'js'   : mode    = 'javascript';       break;
                          
                        }//switch
                        
                        
                        var node    = $(root,'#editor');
                        node.addEventListener('mousedown',update);
                        node.addEventListener('keyup',update);
                        
                        editor      = ace.edit(node);
                        editor.setShowInvisibles(false);
                        editor.setShowPrintMargin(false);
                        editor.setPrintMarginColumn(false);
                        editor.setBehavioursEnabled(false);
                        editor.setDisplayIndentGuides(false);
                        editor.setScrollSpeed(2);
                        editor.setFontSize(16);
                        editor.session.setOptions({tabSize:2,useSoftTabs:true});
                        //editor.setGhostText('\n\nctrl-enter - run & autosave\nctrl-s - save\nctrl-del - delete');
                        editor.session.setMode('ace/mode/'+mode)                        
                        editor.session.on('change',onchange);
                        
                        update();
                        editor.focus();

                                                
                        function onchange(e){
          
                              filename.save(true);
                              update();
                                                
                        }//onchange
                        
                  }//editor

                  
                  import_style.ct   = 0;
                  
                  function import_style(){
                  
                        import_style.ct++;
                        if(import_style.ct>=10){
                                                                                console.log('import_style timeout');
                              return;
                        }
                        
                        var ids   = ['ace-tm','ace_editor\\.css','ace_scrollbar\\.css','error_marker\\.css',];
                        var n     = ids.length;
                        for(var i=0;i<n;i++){
                        
                              var id      = ids[i];
                              var style   = $('#'+id);
                              if(!style){
                                    setTimeout(import_style,500);
                                    return;
                              }
                              
                        }//for
                        
                        for(var i=0;i<n;i++){
                        
                              var id      = ids[i];
                              var style   = $('#'+id);
                              var copy    = style.cloneNode(true);
                              shadow.append(copy);
                        
                        }//for
                        
                        
                  }//style
                  
                  
                  kd.row=function(e){
                        
                        if(e.key=='Enter'){
                              e.preventDefault();
                              var pos   = editor.getCursorPosition();
                              var r     = row.value;
                              var col   = pos.column;
                              editor.gotoLine(r,col);
                              editor.focus();
                        }
                        
                  }//row
          
                  
                  kd.col=function(e){
                        
                        if(e.key=='Enter'){
                              e.preventDefault();
                              var pos   = editor.getCursorPosition();
                              var row   = pos.row;
                              var c     = col.value;
                              editor.gotoLine(row,c);
                              editor.focus();
                        }
                        
                  }//col


                  btn.clear=function(e){
            
                        clear();
            
                  }//clear
            
            
                  btn.copy=function(){
            
                        var txt       = editor.getValue();
                        navigator.clipboard.writeText(txt)
                          .catch(err=>log.error(err));
            
                  }//copy
            
            
                  btn.paste=function(){
            
                        navigator.clipboard.readText()
                          .then(txt=>editor.setValue(txt,-1))
                          .catch(err=>log.error(err));
            
                  }//paste


                  btn.top=function(){
                  
                        editor.gotoLine(0,0);
                        editor.focus();
                        update();
                        
                  }//top
          
                  
                  btn.bottom=function(){
                  
                        editor.gotoLine(999999,0);
                        editor.focus();
                        update();
                        
                  }//bottom



                  obj.filename=filename;
                  
                  function filename(path,icon){
          
                        icon                              = icon||deficon;
                        $(shadow,'#filename-icon').src    = icon;
                        
                        var fn    = '';
                        if(path){
                              var i   = path.lastIndexOf('/');
                              if(i==-1){
                                    fn    = path;
                              }else{
                                    fn    = path.slice(i+1);
                              }
                        }
                        
                        document.title                       = fn||'html-editor';
                        $(shadow,'#filename').textContent    = fn;
                        $(shadow,'#filename').title          = path||'';
                        return fn;
          
                  }//filename
          
          
                  filename.getname=function(path){
                  
                        var name;
                        var i   = path.lastIndexOf('/');
                        if(i==-1){
                              name    = path;
                        }else{
                              name    = path.slice(i+1);
                        }
                      
                  }//getname
                  
                  
                  filename.save=function(status){
          
                        var display   = '';
                        if(!status){
                              display   = 'none';
                        }
                        $(shadow,'#filename-save').style.display   = display;
          
                  }//save
                  
          
                  function update(){
                  
                        var pos     = editor.getCursorPosition();
                        row.value   = pos.row+1;
                        col.value   = pos.column;
                        
                        var n       = editor.getValue().split('\n').length;
                        $(hdr,'#lines').textContent   = n;
                        
                        var n       = editor.getValue().length;
                        $(hdr,'#chars').textCottent   = n;
                        
                  }//update


  //:
  
                  obj.setValue=function(txt){return set(txt)}
                  
                  obj.set=function(txt){return set(txt)}
                  
                  function set(txt){
                  
                        editor.setValue(txt,-1);
                        
                  }//set
                  
              
                  obj.getValue=function(){return get()}
                  
                  obj.get=function(){return get()}
                  
                  function get(){
                  
                        var txt   = editor.getValue();
                        return txt;
                        
                  }//get
                  

                  obj.focus=function(){
                  
                        editor && editor.focus();
                        
                  }//focus


                  obj.resize=function(){
                  
                        editor.resize();
                        
                  }//resize
                  
                  
                  obj.horiz=function(){
                  
                        editor.container.style.width    = '100%';
                        editor.container.style.height   = '50%';
                  
                  }//horiz

                  
                  obj.vert=function(){
                  
                        editor.container.style.width    = '50%';
                        editor.container.style.height   = '100%';
                  
                  }//vert

  //:
  
                  obj.clear=function(){return clear()}
                  
                  function clear(){

                        editor.setValue('',-1);
                        filename();
                        filename.save(false);

                  }//clear
                  
  //:
  
                  function menu(type,opt){
                  
                        if(type=='opt'){
                              menu[opt.id]();
                        }
                        
                  }//menu

                  
                  menu.trim=function(){
                  
                        var pos     = editor.getCursorPostion();
                        var txt     = editor.getValue();
                        var lines   = txt.split('\n');
                        lines       = lines.map(line=>line.trimEnd());
                        txt         = lines.join('\n');
                        editor.setValue(txt,-1);
                        editor.gotoLine(pos.row+1,pos.col);
                        
                  }//trim
                  
                  
              return obj;
              
            }//editor
            
      </script>

</editor-root>

