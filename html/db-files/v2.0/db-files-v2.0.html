


<db-files v2.0>

      <template shadowrootmode=open>
      
      
            <style>
            
  .icon
    {padding:1px}
    
  .menu
    {position:absolute;display:flex;flex-direction:column}
    
  #main-title
    {display:flex;justify-content:space-between;align-items:center}
    
  #menu-ext
    {position:relative}
    
  file-nav
    {flex:1}
    
  #btns
    {display:flex;gap:20px}
    
  input
    {padding:5px 10px;font-size:16px}
  input[type=button]
    {cursor:pointer}
    
            </style>
            
            
            <img class=icon src='data:image/webp;base64,UklGRhwEAABXRUJQVlA4TA8EAAAvHUAHEE2ISVPMfI3of0zzFC0UM5IE9WsvgvWnWpJNo6Bt2zb6/1pOSdqJTNom/l2t12T1P7ZeL6UpFTegz/xCCIcPEiNJUiTJq3uPmfmU+lv1n5mPcaYeenfMTgK4tW2rVub6CkQuPbjG1AAdUANNMF6fRKRkX67cSJIcSfKouXvIIQ7rL8/Kk5Jo2zrm6BSSim3bto1R23aPraFt27Y1im3bTjNa9ac0ARCB5/li+q8NS9iRbWABI8gggoCJrF8YYUMYgzDd2fSSJEGRrKLEineVZUW/mjQcASCLbPSzlJ1mnrpfXdr6Ksz8PJt+a00xnl6u2DujhQuynIcZUYtiEAQAgMHoO/rwGO7Ebf4Et8fTL98J4+lliVtLpG/ACKJIAaYlwBMss5bujaffji3mGsQsN2ZEBjA0xEoIF8a8WyO1Z30+97BhzI4oITsYUxBhZHgozh3ZflbVt06w2B1ufp4VNcP6eTzmSzILVRQRIgwCgCwy9KKbxYO4n1Hf0X1VB7Y5cyqLVsZhsY7Qqc80X1dAUVK1kIpjcSYFnYI0SgxS6pxRdR55n39dDXRV3ydvoWoOnQv240wLGoSyJ1QQfMqUXdX4b5M8lFHGGAbQhgizmDLu/2wm1lGuyCwUnpojSdCHpgWghi4yMhcwgQHqCeunUUxADiCDEbPKzpG5wEGZmIctoARtaEAW96GOGBUhwsgOwABtO+TbV/qvn5SfD8RvKmha1IPOTMCtuA8VZsRMRx1RoBREQIX/7JE3n+k/vhGbgV5qb73MxGN2z7g9SWI3I7338DjDU+gcWTDADGw4CgAAgAGo/T3FT7NOvsp4q8j/vYtbt0dbCcrMQ1R29kw/I8qQIYsQFQAAmMYwVRb7eK6y71kaRLQgDXac153MnarCAxRz2MItywnWzBgykN1s2ASNUl9Y90MNfo74saJCG5GE5S0AMRJj7y76WHWmKtOCoeB/SF6kAn2PJCPLzhi2gXcQahRmzwWZkEAzAQCI4QIA1JBjBgKU0EAKHehCF2ID9RIz9w9xAAOgjQkIYLAd5t6PtW/UYxgU+N9CK65iO3SHgDhAOT+e/po1cxvVLbgiB8uwGXGwGIC/9kptrcJbeLRgiYu4jG0wQjjC4QUbGEMHUgAlBExgBO2oQgV+iyGuwrEFDVxxCY34gTy0YRJABhmkEEEJAQLUMIQ7Eg3ZuAVvaFoAaogQgJ1Q4jeGMYxx/IcAoA0jWMIWtrAwT6scDZFADdpQgeF2mLuLlc9RL2EPqFpoR/UwA6NrzD8j/6Ga0NjCCLbiBSaGAAP2pvv/PqiN6G4BNGId5uAE4uAOM8ggakGOf+hGMb6qlagEkyEgD/tgAFs4wR6WMIIMIgiYwC8Mog9DmASYAc8RAA=='>
            
            <div class=menu style='display:none;left:45px;top:45px;width:600px;height:500px'>
            
                  <div id=main-title class=menu-title>
                        <span>
                        </span>
                        <span>
                              browser fs - indexed db
                        </span>
                        
                        <span id=menu-ext>
                        
                              <db-list v2.0 component=parent parent=db-files></db-list>
                              
                        </span>
                  </div>
                  
                  <file-nav component></file-nav>
                  
                  <div id=btns>
                        <input value=update type=button>
                        <input value=load type=button>
                        <input value=save type=button>
                        <input value=dir type=button>
                  </div>
                  
            </div>
            
            
      </template>
      
      
      <script>
      
(function db_files({mod,dom,host}){

  var obj   = {
        version   : 'v1.0'
  };
  
        var df=false,did='db-files'
        ;
        
        
  //initmod:
  
        var ext,$,datatype,menumod,source,filemod,log
        ;
        
        obj.initmod   = function(params){
        
              ext         = mod.rd(params,'ext',ext);
              $           = mod.rd(params,'$',$);
              datatype    = mod.rd(params,'datatype',datatype);
              menumod     = mod.rd(params,'menumod',menumod);
              
              menu.root   = mod.rd(params,'menu',menu);
              
              source      = mod.rd(params,'source',source);
              
              filemod     = mod.rd(params,'filemod',filemod);
              
              log         = mod.rd(params,'log',log);
              
        }//initmod
        
        
  //vars:-
  
  
        var status        = false;
        
        
        var db;
        var dblist;
        var filenav;
        
        var filetype      = 'db-files';
        
        var prefix        = 'fs';
        var list;
        
        
        var root;
        var shadow;
        
        var icon;
        
        var menu          = {};
        
        var btn           = {};
        var file          = {};
        var dir           = {};
        
  //:
  
  
        obj.init    = async function(){
                                                                                debug('init',obj.version);
              //var resolve;
              //obj.init    = new Promise(res=>resolve=res);
              
              menu.dbfiles              = menumod();
              
              await libs();
              
              dblist                    = mod['db-list'];
              filenav                   = mod['file-nav'];
              
              
              dblist.initmod({ext,$,datatype,menu:menu.dbfiles,db});
              
              filenav.initmod({ext,$,datatype});
              filenav.file    = file;
              filenav.dir     = dir;
              
              await Promise.all([
                    dblist.init(),
                    filenav.init(),
              ]);
              
              
              db.df                     = false;
              
              var {names,error}   = db.list();
              status    = error;
              if(error){
                                                                                debug(error);
              }
              //resolve
              
        }//init
        
        
        async function libs(){
        
              libs   = ext.load.libs(
                    'js/core/dbmod/db-fs/db-fs.js.api'
              );
              [db]    = await libs;
              
        }//libs
        
        
  //:
  
  
        obj.initdom   = async function(){
        
              shadow                                            = host.shadowRoot;
              
              menu.root.add.style(shadow);
              
              var style                                         = $(shadow,'style');
              $.stylesheet.insert(style,'.icon');
              
              var node                                          = $(shadow,'.menu');
              icon                                              = $(shadow,'.icon');
              icon.onclick                                      = menu.root.click(node,{callback:menu_callback});
              
              
              dblist.initdom(shadow);
              
              filenav.initdom();
              
              
              $(shadow,'[value=update]').onclick                = btn.update;
              $(shadow,'[value=load]').onclick                  = btn.load;
              $(shadow,'[value=save]').onclick                  = btn.save;
              $(shadow,'[value=dir]').onclick                   = btn.dir;
              
              
              //read();
              
        }//initdom
        
        
  //:
  
/*
        btn.dblist    = function(){
        
              db.list();
              
        }//dblist
*/


        btn.update    = function(){
                                                                                debug('btn.update');
              var path    = filenav.path;
                                                                                debug(path);
              if(status){
                    log(status);
                    return;
              }
              
              read(path);
              
        }//update
        
        
        btn.load    = function(){
                                                                                debug('btn.load');
              if(filenav.cur.type!=='file'){
                    alert('no file selected');
                    return;
              }
              
              if(status){
                    log(status);
                    return;
              }
              
              var path    = filenav.cur.path;
              var name    = filenav.cur.name;
                                                                                debug(path,name);
              load.ui(path,name);
              
        }//load
        
        
        btn.save    = function(){
                                                                                debug('btn.save');
              if(filenav.cur.type!=='file'){
                    alert('no file selected');
                    return;
              }
              
              if(status){
                    log(status);
                    return;
              }
              
              var path    = filenav.cur.path;
              var name    = filenav.cur.name;
                                                                                debug(path,name);
              save.ui(path,name);
              
        }//save
        
        
        btn.dir   = function(){
                                                                                debug('btn.date');
                                                                                debug('!! not implemented !!');
              if(status){
                    log(status);
                    return;
              }
              
        }//dir
        
        
  //:
  
  
        function menu_callback(type){
        
              switch(type){
              
                case 'show'   : read();       break;
                
              }//switch
              
        }//menu_callback
        
        
  //:
  
  
        file.add    = async function(path,name){
                                                                                debug('db-files.file.add',path+name);
              var abs     = prefix+path+name;
                                                                                debug(abs);
              if(status){
                    log(status);
                    return;
              }
              
              var fs      = await db.open(abs);
              fs.write.str('');
              fs.close();
              return false;
              
        }//add
        
        
        file.rem    = async function(path,name){
                                                                                debug('db-files.file.rem',path,name);
              var abs       = prefix+path+name;
                                                                                debug(abs);
              if(status){
                    log(status);
                    return;
              }
              
              var result    = await db.delete(abs);
              return false;
              
        }//rem
        
        
        file.upload   = async function(path,name,blob){
        
              var abs     = prefix+path+name;
              
              if(status){
                    log(status);
                    return;
              }
              
              var file    = await db.open(abs);
              await file.write(blob);
              file.close();
              return false;
              
        }//upload
        
        
        file.download   = async function(path){
        
              var abs     = prefix+path;
              
              if(status){
                    log(status);
                    return;
              }
              
              var file    = await db.open(abs);
              var blob    = await file.read();
              file.close();
              return {result:false,blob};
              
        }//download
        
        
        file.dblclick   = async function(path,name){
        
              var abs     = prefix+path+name;
              
              if(status){
                    log(status);
                    return;
              }
              
              var fs      = await db.open(abs);
              var blob    = await fs.read();
              if(!blob){
                    blob    = new Blob(['']);
              }
              fs.close();
              
              var file        = {};
              file.type       = filetype;
              file.filename   = name;
              file.title      = abs;
              file.icon       = icon.src;
              file.abs        = abs;
              
              obj.load.complete(file,blob);
              
        }//dblclick
        
        
        dir.parent    = function(){
        
              if(status){
                    log(status);
                    return;
              }
              
        }//parent
        
        
        dir.add   = async function(path,name){
                                                                                debug('dir.add',path,name);
              var abs     = prefix+path+name+'/';
                                                                                debug(abs);
              if(status){
                    log(status);
                    return;
              }
              
              var file    = await db.open(abs);
              file.close();
              return false;
              
        }//add
        
        
        dir.rem   = async function(path,name){
                                                                                debug('dir.rem',path,name);
              var abs     = prefix+path+name;
              
              if(status){
                    log(status);
                    return;
              }
              
              var {names:list}    = await db.list(abs);
              
              var n   = list.length;
              for(var i=0;i<n;i++){
              
                    var fn        = list[i];
                    var result    = await db.delete(fn);
                    
              }//for
              
              return false;
              
        }//rem
        
        
        dir.clear   = async function(path){
                                                                                debug('dir.clear',path);
              var abs     = prefix+path;
              
              if(status){
                    log(status);
                    return;
              }
              
              var {names:list}    = await db.list(abs);
              
              var n   = list.length;
              for(var i=0;i<n;i++){
              
                    var fn    = list[i];
                    if(fn.length>abs.length){
                          var result    = await db.delete(fn);
                    }
                    
              }//for
              
              return false;
              
        }//clear
        
        
        dir.read    = read;
        
        
        dir.dblclick    = function(path,name){
                                                                                debug('dir.dblclick',path,name);
              if(status){
                    log(status);
                    return;
              }
              
              read(path+name);
              return false;
              
        }//dblclick
        
        
  //:
  
  
        async function read(path){
                                                                                debug('dir.read');
              path        ||= filenav.path;
              
              if(status){
                    log(status);
                    return;
              }
              
              var len       = prefix.length+path.length;
              
              var dirs      = [];
              var files     = [];
              
              var {names:list}      = await db.list(prefix+path,true);
              list.forEach(abs=>{
              
                    var i   = abs.indexOf('/',len);
                                                                                //console.log(abs,i);
                    var fn;
                    if(i==-1){
                          fn    = abs.slice(len);
                          if(fn){
                                files.push(fn);
                          }
                    }else{
                          fn    = abs.slice(len,i);
                          if(dirs.indexOf(fn)==-1){
                                dirs.push(fn);
                          }
                    }
                    
              });
                                                                                //console.log(dirs);
                                                                                //console.log(files);
              filenav.display(path,dirs,files);
              return false;
              
        }//read
        
        
  //:
  
  
        obj.load    = load;
        
        async function load(file){
        
              if(status){
                    log(status);
                    return false;
              }
              
              if(!await db.exists(file.abs)){
                    return false;
              }
              
              var fs      = await db.open(file.abs);
              var blob    = await fs.read();
              fs.close();
              return blob;
              
        }//load
        
        
        load.ui   = async function(path,name){
        
              var abs         = prefix+path+name;
              
              if(status){
                    log(status);
                    return;
              }
              
              var file        = {};
              file.type       = filetype;
              file.name       = name;
              file.title      = abs;
              file.icon       = icon.src;
              file.abs        = abs;
              
              var result      = await load(file);
              if(result===false){
                     return;
              }
              var blob    = result;
              
              obj.load.complete(file,blob);
              
        }//load.ui
        
        
        obj.save    = save;
        
        async function save(file,blob){
        
              if(status){
                    log(status);
                    return;
              }
              
              var fs    = await db.open(file.abs);
              await fs.write(blob);
              
              obj.save.complete(file);
              
        }//save
        
        
        save.ui   = async function(path,name){
        
              var abs         = prefix+path+name;
              
              if(status){
                    log(status);
                    return;
              }
              
              var title       = abs;
              
              var file        = {};
              file.type       = filetype;
              file.abs        = abs;
              file.path       = path;
              file.name       = name;
              file.title      = title;
              file.icon       = icon.src;
              
              var blob        = await source();
              
              var result      = await save(file,blob);
              if(result===false){
                    return;
              }
              
        }//save.ui
        
        
        obj.newfile   = newfile;
        
        function newfile({path,name}){
        
              if(arguments.length>1){
                    [path,name]   = arguments;
              }
              
              var abs         = prefix+path+name;
              
              if(status){
                    log(status);
                    return;
              }
              
              var title       = prefix+path+name;
              
              var file        = {};
              file.abs        = abs;
              file.path       = path;
              file.name       = name;
              file.title      = title;
              file.icon       = icon.src;
              
              return file;
              
        }//newfile
        
        
        
        
/*
        async function del(filename){
        
              if(!exists(filename)){
                    return false;
              }
              var db    = await dbmod(filename);
              await db.delete();
              
        }//delete
*/


  //:
  
  
        function debug(...args){
        
              if(!df && !obj.df)return;
              args.unshift(`[ ${did} ]`);
              console.groupCollapsed.apply(console,args);
              console.trace();
              console.groupEnd();
              
        }//debug
        
        
        
  return obj;
  
//db_files
})

      </script>
      
</db-files>



