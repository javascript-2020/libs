


<web-console v2.0>

      <template shadowrootmode=open>
      
            <style>
            
  :host
    {all:initial;font-family:arial;display:block}
    
  #console
    {border:1px solid lightgray;min-height:50px}
    
    
  #ftr
    {display:flex;gap:10px}
    
  #ftr>div
    {display:flex;}
    
  .icon
    {width:20px;height:20px;border:1px solid lightgray;border-radius:3px;box-sizing:border-box}
  #clear
    {}
  #log-icon
    {}
  #warn-icon
    {}
  #error-icon
    {}
    
    
            </style>
            
            
            <div id=console part=console>
            </div>
            
            
            <div id=ftr>
            
                  <img id=clear>
                  
                  <div id=log-root>
                        <img id=log-icon>
                        <div id=log></div>
                  </div>
                  
                  <div id=warn-root>
                        <img id=warn-icon>
                        <div id=warn></div>
                  </div>
                  
                  <div id=error-root>
                        <img id=error-icon>
                        <div id=error></div>
                  </div>
                  
            </div>
            
            
      </template>
      
      
      <script>
      
      
(function web_console({mod,dom,host}){

  var obj   = {
        version   : 'v2.0',
  };
  
        var df=true,did='web-console'
        ;
        
        var ext,$,ace,embed,config={}
        ;
        
        obj.initmod   = function(params){
        
              ext       = mod.rd(params,'ext',ext);
              $         = mod.rd(params,'$',$);
              ace       = mod.rd(params,'ace',ace);
              embed     = mod.rd(params,'embed',embed);
              config    = mod.rd(params,'config',config,{});
              echo      = mod.rd(params,'echo',echo);
              
        }//initmod
        
        
  //:
  
  
        var ansi;
        
        
        
        var echo    = true;
        
        
        
        var jsconsole;
        var con;
        var style;
        
        
        var root;
        
        
        var def             = {};
        def.fullsize        = false;
        def.height          = '200px';
        
        var fullsize;
        var height;
        
        
        update.initial      = true;
        
        
        var rd              = {};
        rd.attr             = {};
        
        
        
        
        
  //:
  
  
        obj.init    = async function(){
                                                                                debug('init',obj.version);
              var dom_config    = mod.rd.config(dom);
              config            = Object.assign(config,dom_config);
                                                                                debug('config',config);
                                                                                
              target    = dom;
              if(embed){
                    target    = embed;
              }
              
              rd.attr.fullsize();
              rd.attr.h();
              rd.attr.height();
              
              
              await libs();
              
              
        }//init
        
        
        async function libs(){
        
              if(!ace){
                    ace   = await $.editor.ace();
              }
              
              var list      = [];
              
              var promise   = ext.load.libs('js/dom/web-console/web-console.js').then(result=>{
              
                    [jsconsole]   = result;
                    jsconsole.initmod({ace});
                    jsconsole.init();
                    
              });
              list.push(promise);
              
              
              var promise   = ext.text.libs('js/dom/web-console/web-console.css').then(result=>{
              
                    var [css]           = result;
                    style               = document.createElement('style');
                    style.textContent   = css;
                    
                    
              });
              list.push(promise);
              
              
/*
              var promise   = import('https://cdn.jsdelivr.net/npm/ansi_up/+esm').then(({AnsiUp})=>{
              
                    ansi    = new AnsiUp();
                    
              });
              list.push(promise);
*/



              await Promise.all(list);
              
        }//libs
        
        
  //:
  
  
        rd.attr.fullsize   = function(){
        
              if(!target.hasAttribute('fullsize'))return;
              
              def.fullsize    = true;
              
        }//fullsize
        
        
        rd.attr.h   = function(){
        
              if(!target.hasAttribute('h'))return;
              
              var h         = target.getAttribute('h');
              h             = int(h);
              def.height    = h;
              
        }//h
        
        
        rd.attr.height    = function(){
        
              if(!target.hasAttribute('height'))return;
              
              var h         = target.getAttribute('height');
              h             = int(h);
              def.height    = h;
              
        }//height
        
        
  //:
  
  
  
  
        obj.initdom    = function(params={}){
                                                                                debug('initdom');
              fullsize        = params.fullsize||config.fullsize||def.fullsize;
                                                                                debug('fullsize',fullsize);
              height          = params.height||params.h||config.height||config.h||def.height;
              if(height){
                    //fullsize    = false;
              }
              
              
              var shadow      = host.shadowRoot;
              
              
              $.editor.ace.import_style(shadow,()=>shadow.append(style));
              
              
              var node        = $(shadow,'#console');
              con             = jsconsole.create(node);
                                                                                //console.log(con);
                                                                                //console.log(con.element===node);
                                                                                
              if(height){
                                                                                debug('height',height);
                    obj.height      = height;
              }
              
              
              setTimeout(()=>update.initial=false,50);
              
        }//initdom2
        
        
  //:
  
  
        function update(){
                                                                                debug('update');
              if(fullsize){
              
                    if(update.initial)return;
                    
                    var node    = con.element;
                    var h       = node.scrollHeight;
                                                                                //console.log('update',h);
                    node.style.height   = h+'px';
              }
              
        }//update
        
        
        
  //  ext
  
        obj.write   = function(){
        
              con.write.apply(con,arguments);
              if(echo){
                    window.console.log.apply(window.console,arguments);
              }
              
              update();
              
        }//write
        
        
        obj.json    = function(){
        
              var args    = [...arguments];
              args.forEach(v=>{
              
                    var str   = JSON.stringify(v,null,4);
                    obj.log(str);
                    
              });
              
        }//json
        
        
        obj.debug   = function(...args){
        
              args.unshift('[ debug ]');
              con.log.apply(con,args);
              
              if(echo){
                    window.console.debug.apply(window.console,args);
              }
              
              update();
              
        }//debug
        
        
        
  //  standard
  
  
        var api         = [
                                'assert','clear','count','countReset','debug','dir','dirxml','error','group','groupCollapsed',
                                'groupEnd','info','log','profile','profileEnd','table','time',
                                'timeEnd','timeLog','timeStamp','trace','warn'
                          ];
                          
        api.forEach(name=>{
        
              var fn      = ()=>{};
              if(window.console[name]){
                    fn    = window.console[name].bind(window.console);
              }
              obj[name]   = fn;
              
        });
        
        
        obj.log   = function(){
        
              con.log.apply(con,arguments);
              
              if(echo){
                    window.console.log.apply(window.console,arguments);
              }
              
              update();
              
        }//log
        
        
        obj.clear   = function(){
        
              con.clear.apply(con);
              
              if(echo){
                    window.console.clear();
              }
              
              if(fullsize){
                console.log('clear',height);
                    obj.height    = height;
              }
              
              update();
              
        }//clear
        
        
        obj.error   = function(){
        
              con.error.apply(con,arguments);
              
              if(echo){
                    window.console.error.apply(window.console,arguments);
              }
              
              update();
              
        }//error
        
        
        obj.warn    = function(){
        
              con.warn.apply(con,arguments);
              
              if(echo){
                    window.console.warn.apply(window.console,arguments);
              }
              
              update();
              
        }//warn
        
        
        
        
  //:
  
  
        Object.defineProperty(obj,'height',{
        
              set   : v=>{
                                                                          //window.console.log('console.height',v);
                    if(!v)return;
                    v   = int(v);
                    if(typeof v=='number'){
                          v  += 'px';
                    }
                    con.element.style.height    = v;
                    
              },
              
        });
        
        
        Object.defineProperty(obj,'echo',{
        
              set   : v=>echo=!!v
              
        });
        
        
        
  //:
  
  
        function int(str){return (/^\d+$/.test(str)) ? Number(str) : str}
        
        
        
  //:
  
  
        obj.test    = function(){
        
        
              con.log('helloworld');
              
              var test    = {
                    hello:'world',
                    key:'value',
                    test:123,
                    debug:true
              };
              
              con.log(test);
              
              
        }//test
        
        
        
  //:
  
  
        function debug(...args){
        
              if(!df && !obj.df)return;
              args.unshift(`[ ${did} ]`);
              var fmt     = Array.from({length:args.length}).fill('%O').join(' ');
              var args2   = [fmt].concat(args);
              window.console.groupCollapsed.apply(window.console,args2);
              window.console.trace();
              window.console.groupEnd();
              
        }//debug
        
        
        
        
        
  return obj;
  
//web_console
})


      </script>
      
      
</web-console>





