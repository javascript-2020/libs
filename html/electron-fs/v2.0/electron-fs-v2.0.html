

<electron-fs>

      <template shadowrootmode=open>
      
            <style>
            
  [root]
    {}
    
    
  .menu
    {position:absolute;outline:none;font-family:arial;display:flex;flex-direction:column}
    
  input
    {font-size:16px;padding:5px 10px}
    
  .icon
    {padding:1px}
    
  file-nav
    {flex:1}
    
            </style>
            
            <img class=icon style='display:none' src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAMAAAAM7l6QAAAAS1BMVEVHcEx4sLx2sLx0sb50sb6Cr7Z2sb10sb52sb10sb51sb10sb51sb10sb10sb51sb18sLl0sb51sb11sb17sLp1sb11sb11sL1zsb6hkbGfAAAAGHRSTlMAEx3StgI4rSzKedlLwJqHBKNikAlCblSrNgHaAAABdUlEQVQoz31TV3bEIAwERO/de/+TRhg7u8mLoy9AbWYkCPk0Zi0jj9ZLMCU/upmTwx3P2SoEcPU5HXsfzpP/zAb68yHLmVqa+jyzYWZNVd8QBSvAY4scQbGqQNlgS4B4UaRc6b7ChE4Q0qAMJOlS8bOHqGb3YgmUX8es7LqaTSGmM+ow3PcLnFqNW3y7aXKz31D9We9yW54JU0EScbs1IInO5744ybjaOOkJY2EjEvRm3ZJSG50HWJJRM1DgeFWjZXPAeq8XdkK3J/NKJuQAK7dA8fVaOeim4Z4cDbNeY7jWAYsLdovqgYnpqvgY3HdhtBSXdC695yThvVJiUcanEPxdrwZUSNqxCnrHF01CrStyByy9BnAY61w6xxFkKnR06sAWmdele1dL7cMVh2FUoao6GRPrmFJ7js+LTj6axya5tJOlb9wYAFNmOj53ejh54bZaayp+bWCOW1rK299bHArSZSU8/CPNTWtG6acNp7WU+mPJvwC81hAhY7JVwwAAAABJRU5ErkJggg=='>
            
            <div root class=menu style='display:none;left:10px;top:100px;width:750px;height:500px'>
            
                  <div class=menu-title>
                        electron fs
                  </div>
                  
                  <file-nav v2.0 component></file-nav>
                  
                  <div btns>
                        <input value=dir type=button>
                        <input value=load type=button>
                        <input value=save type=button>
                  </div btns>
                  
            </div root>
            
      </template>
      
      <script>
      
(function({mod,dom,host}){

  var obj   = {
        version   : 'v2.0',
  };
  
        var df=false,did='electron-fs'
        ;
        
        var ext,$,menu,source,filemod,log
        ;
        
        obj.initmod   = function(params){
        
              ext         = mod.rd(params,'ext',ext);
              $           = mod.rd(params,'$',$);
              menu        = mod.rd(params,'menu',menu);
              source      = mod.rd(params,'source',source);
              filemod     = mod.rd(params,'filemod',filemod);
              log         = mod.rd(params,'log',log);
              
        }//initmod
        
        
  //vars:-
  
  
  
  //:
  
        var electron;
        
        
        var filenav;
        
        var filetype    = 'electron';
        
        var shadow;
        var ui          = {};
        var icon;
        
        
        var btn         = {};
        var file        = {};
        var dir         = {};
        
        
  //:
  
  
        obj.init    = async function(){
                                                                                debug('init',obj.version);
                                                                                
              electron                  = window.electronAPI;
                                                                                debug('enabled');
              filenav                   = mod['file-nav'];
              //filenav.rd.params         = rd.params;
              filenav.file.click        = file.click;
              filenav.file.dblclick     = file.dblclick;
              filenav.dir.read          = dir.read;
              filenav.dir.click         = dir.click;
              filenav.dir.dblclick      = dir.dblclick;
              
              await mod.auto();
              
              if(!electron){
                                                                                debug('not enabled');
                    return;
              }
              
              
        }//init
        
        
  //:
  
  
        obj.initdom   = function(){
        
              if(!electron){
                    return;
              }
                                                                                debug('initdom');
                                                                                
              shadow                                  = host.shadowRoot;
              
              menu.add.style(shadow);
              
              var style                               = $(shadow,'style');
              $.stylesheet.insert(style,'.icon');
              
              
              var node                                = $(shadow,'.menu');
              icon                                    = $(shadow,'.icon');
              icon.onclick                            = menu.click(node,'both',false);
              icon.style.display                      = '';
              
              
              $(shadow,'[value=load]').onclick        = btn.load;
              $(shadow,'[value=save]').onclick        = btn.save;
              $(shadow,'[value=dir]').onclick         = btn.dir;
              
              
        }//initdom
        
        
  //:
  
  
        btn.load    = function(){
                                                                                debug('btn.load');
              if(filenav.cur.type!=='file'){
                    alert('no file selected');
                    return;
              }
              
              var path        = filenav.cur.path;
              var filename    = filenav.cur.filename;
                                                                                debug(url,path,filename);
              load.ui(path,filename);
              
              
        }//load
        
        
        btn.save    = function(){
                                                                                debug('btn.save');
              if(filenav.cur.type!=='file'){
                    alert('no file selected');
                    return;
              }
              
              
              var path        = filenav.cur.path;
              var filename    = filenav.cur.filename;
              
              save.ui(path,filename);
              
        }//save
        
        
        btn.dir   = function(){
        }//dir
        
        
        function menu_callback(){
                                                                                console.log('menu_callback',arguments);
        }//menu_callback
        
        
  //:
  
  
        obj.update    = update;
        
        function update(path){
        
              if(!filenav)return;
              
              filenav.update(path);
              
        }//update
        
        
  //:
  
        file.click    = function(path,filename){
                                                                                debug('file.click',path,filename);
        }//click
        
        
        file.dblclick   = function(path,filename){
                                                                                debug('file.dblclick',path,filename);
              load.ui(path,filename);
              
        }//dblclick
        
        
        dir.read    = async function(path){
                                                                                debug('dir.read',path);
              var {files,dirs,error}    = await electron.dirRead({path});
              
              if(error){
                    console.error(error);
                    return;
              }
              
              filenav.display(path,dirs,files);
              
              return false;
              
        }//read
        
        
        dir.click   = function(path,filename){
        }//click
        
        
        dir.dblclick    = function(path,filename){
                                                                                debug('dir.dblclick',path,filename);
              var abs   = path+filename;
              filenav.update(abs);
              
        }//dblclick
        
        
  //:
  
  
        load.ui   = async function(path,filename){
                                                                                debug('load.ui',path,filename);
              var title       = `${path}\n${filename}`;
              
              var file;
              
              if(filemod){
                    file            = filemod.newfile({
                    
                          filetype    : filetype,
                          abs         : `${path}${filename}`,
                          path        : path,
                          name        : filename,
                          
                          kind        : 'file',
                          size        : null,
                          ctime       : null,
                          mtime       : null,
                          atime       : null,
                          
                          title       : title,
                          icon        : icon.src
                          
                    });
              }else{
                    file            = {
                    
                          filetype    : filetype,
                          abs         : `${path}${filename}`,
                          path        : path,
                          name        : filename,
                          
                          kind        : 'file',
                          size        : null,
                          ctime       : null,
                          mtime       : null,
                          atime       : null,
                          
                          title       : title,
                          icon        : icon.src
                          
                    };
              }
              
              var result      = await load(file);
              if(result===false){
                     return;
              }
              var blob    = result;
              
              obj.load?.complete?.(file,blob);
              
              return blob;
              
        }//load.ui
        
        
        obj.load    = load;
        
        async function load(file){
                                                                                debug('load',file);
              var path    = file.abs;
              var buf     = await electron.readFile({path});
              var blob    = new Blob([buf]);
              return blob;
              
        }//load
        
        
        save.ui   = async function(path,filename){
                                                                                debug('save.ui',path,filename);
              var title       = `${path}${filename}`;
              
              var file;
              if(filemod){
                    file            = filemod.newfile({
                    
                          filetype    : filetype,
                          abs         : path,
                          path        : path,
                          name        : filename,
                          
                          kind        : 'file',
                          size        : null,
                          ctime       : null,
                          mtime       : null,
                          atime       : null,
                          
                          title       : title,
                          icon        : icon.src
                          
                    });
                    file.url    = url;
              }else{
                    file            = {
                    
                          filetype    : filetype,
                          abs         : `${path}${filename}`,
                          path        : path,
                          name        : filename,
                          
                          kind        : 'file',
                          size        : null,
                          ctime       : null,
                          mtime       : null,
                          atime       : null,
                          
                          title       : title,
                          icon        : icon.src
                          
                    }
              }
              
              
              var blob        = await source();
              
              var result      = await save(file,blob);
              if(result===false){
                    return;
              }
              
              
        }//save.ui
        
        
        obj.save    = save;
        
        async function save(file,blob){
                                                                                debug('save',file);
              var path      = file.abs;
              var buf       = await blob.arrayBuffer();
              buf           = new Uint8Array(buf);
              var {error}   = await electron.writeFile({path,buf});
              if(error){
                                                                                console.error(error);
                    return false;
              }
              
              obj.save?.complete?.(file);
              
              return true;
              
        }//save
        
        
        
  //:
  
  
        function debug(...args){
        
              if(!df && !obj.df)return;
              args.unshift(`[ ${did} ]`);
              var fmt     = Array.from({length:args.length}).fill('%O').join(' ');
              var args2   = [fmt].concat(args);
              console.groupCollapsed.apply(console,args2);
              console.trace();
              console.groupEnd();
              
        }//debug
        
        
        
        
  return obj;
  
})

      </script>
      
</electron-fs>


