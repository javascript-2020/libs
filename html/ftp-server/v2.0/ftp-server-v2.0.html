

<ftp-server v2.0>

      <template shadowrootmode=open>
      
            <style>
            
  :host
    {font-family:arial}
    
    
  .hr
    {border-top:1px solid lightgray;margin:10px 20px}
    
  .menu
    {position:absolute;outline:none;display:flex;flex-direction:column}
    
    
  .category
    {display:flex;flex-direction:column;gap:5px}
  .field
    {display:flex;align-items:center;gap:5px;}
  .value
    {flex:1}
    
  label
    {width:70px;text-align:right;margin-right:10px}
    
    
  #server-root
    {}
    
    
  #url-root
    {}
  #url
    {}
    
    
  #auth-root
    {}
  #auth
    {}
  #auth-chk
    {}
    
    
    
  .copy
    {padding:2px;width:24px;height:24px;border:1px solid gray;cursor:pointer;border-radius:3px;
      content:url(data:image/jpeg;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAMAAAC7IEhfAAABSlBMVEVHcEwnz/4C8P4g1P4L6P43wf5Mr/4a2v4Y3P4/uv5PrP4+vf5Auv4ozv5KsP4vyv45wP5Jsf5Auf49vP5Mrv4zxf44wf5Lr/46wP4h1P5Lr/46vv5Jsv4R5P5Hs/5Etv44wf5Hs/41w/4uyv47vv49vP5Ftf5GtP4c2f4rzP4tyv4m0f5Etv5Nrv4xxv4xxv4xx/4W3/5KsP5Mr/4/u/4uyv5Isv4K6f4l0f4qzv4W3/4V3/5Nrv5Mrv5Mrv5Mr/4W3v4e2P5BuP5Hsv4N5v4K6f4O5v42w/5Dt/4E7/4uyf4C8P4nz/4M5/4K6v4oz/4P5f4k0v4b2v5Gs/4E7v4I6/5Nrf4e1/4H7P4E7v5Auv5Dtv4sy/5Isv5GtP4wx/49vP4zxf47vv44wP42w/5LsP5Jsf4i1P4n0P4N5v4k0v4a2v4S4v4X3v6OfcqkAAAAVnRSTlMACo7CjQWN/VczjgIJMfIXJzHtjj5iVekR71Hvtz7CjelXjre2wiJj2PCFIWbR7+fEnXaodz3544/USfOC22Tm7CXOnqfUZ+/3VTV9bsTzqGDahpb2tyRB6bIAAAIDSURBVDjLrZVpV9pAFIYntdFiQkZsLCQECtJSlqAsFRBU3Kuta1sncYGuJEDt///aISkkkyHo6enzLTlP5s5758wNAC526pd3d1++/fzx/evNze1tp210wxURUMTWBz2v2EWtLc7jBTPmoJfNrqy8i0ajixgB00VISJIeW9JMKbcWDAYDNiFMQN1EqAAJcUfSBif0fsQWQjLxpjGnXUJa5CoIbTiP8KJ0OqfNMLQIZhGad/Ke3t///vWwGKv1+yPxfW55+TnmJWZW5ggxcqX3m6WSVTpSdPcxHCLExmf97AI8e1j8cK1f8X9Fq/Sotrf0k2v9KRiJ08L8mwhf2CQx8oK/yJyPw3Q67ULaV4Tr7tRCwFfkllLF4ushccwGPyUMzwzhMQz/X1Kz+QVMmh2LcjgsTxDZ3OpqIpFYfDu+KGwoxE5JvTtpF9NX9BEB792jn0gD4eNEsVAQHyXOO7fQFmNNLZOnPV5BqEyI+Yxm1qkluS0BCWRp8FEze6mTJQtVVd8MUfcEhBSGFOGMOWmaoc0AmRoXP5cmiHEReEXANOopzCsLRYlXjWolGXE2jK/r/ujEWAdOFIxWGrjO8ljXazG6MeynthEn2gAP9P7B4XCE2thzdG2v2jbK5LfHZ3hINbclSco6o/kIh1Einq4e1qxp5m2PkqZ/CPvbXvFot+xe7w/EpaiUrJ24NAAAAABJRU5ErkJggg==);
    }
  .paste
    {padding:2px;width:24px;height:24px;border:1px solid gray;cursor:pointer;border-radius:3px;
      content:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAAAVlJREFUSEvtlj1ug0AQhcdIW6RLeiQy6XKElLRIlOlp6LmBlRsgtzTUOQAtcZMzpMpInAGlQSjRWl7LxrM/dlhZUbwtu/PNvH07zAIutBYX4oIzGBG/95MkIuezXHFOh6MoegqC4F0GEELAMAybWL+BG8GI+AwArypjRFTAgyLOSeAIHIbhjRDii5NHgcdxhK7rWHu4JnEEnt6ljK6AUxIRcfAPInq0mVYL/lwSrNa3UL7d2WKA3CvXw8vuKqzeMYKtxMmGK9ik2FVq+XQ2rVE5VSeXMpLNgLp3fZbUrlCVFAc/GaygbdvaioU4jrU9/W+CVUVc6U3TQJIkfio2geVV/C+pi6KAsiz9SN33PaRpyrrbu9R1XbPgLMv83bHJXHmeQ1VVp0tt6w6zN5DtqHMwynJJeAGbqkVEOefc2xTZ/+7Uq10CcgOh7pzz38kFPMce6zQ4B4SL8QNf7+YfCGbtNAAAAABJRU5ErkJggg==);
    }
    
    
  #btns
    {display:flex;gap:5px;margin-bottom:10px}
    
  #parent-dir
    {cursor:pointer;width:32px;height:32px;border:1px solid gray;box-sizing:border-box;padding:1px;border-radius:3px;
      content:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAMAAAAM7l6QAAACUlBMVEVHcExuOx0oGCWETB3654yOUhicYhejaByKTRiZXiCwdBPBgw/RkxC3i0P64nz77JTXpzecZR+rejPdohDfohGvcRC3fRPJkR1DoSczaSzKpFDoy3C4gijjukurcyKxdxo/iCXFjB/1yTvKlRD67pnz2G6iZxLz3XbBlEHNplHkvUnOrEvkyGWPizrbnhJBmiforRhClSpHqSbSr1c4fyrVtlv0y0nz0FqygTf10WPXr1TlyW7s2IVRsi7VpR7ry2HSoSW9hg312WX13321fA3EjA7TnxOnaRG3fQ3XuF1AmCjSozr45oeLgzKiZA+jZxDEkCvSlhHDhRDFiRC5izrev1z7xCL7whtNtif7xyn5yTDY0Ef732T63V77zz371k3511P62lj8wRr70kT67IL642/7yzT7xiX5vxr66HrZ11ja3mLa2l5o2jt06kLssBPX1FP74WpRvCv65XPLkw/g02Fu5T5x6ED3xy7gxjXY001OuSj61EjuzElanSz2uxbwxDfbqRrn2m9cyjFk1Tdg0TTpxC/pyj3Xyz/lz0dKsib3533kujT864Ll01FTwCy2vlDowT/KlhbgtDb34m3aqzRXxS56qDnx2V2wmh3ptSpxvjHTujbz0UzRmBb66X5Uvi7quCFztDrX0F6Jqyb32V386nr33miUpCpr3zxfsjJuxTveyzzVxzv0uhXUxTjs4Hb664GBs0SfwVVlqDXfrh7SnCHo1FnGqipIqCbJmiVp3z1syzTDiQjPrSvrzlPbrjjU1WrWpDLv1GbDpSfAyVlltKRaAAAAVnRSTlMACAMNzBkyPBIjdaXVYc3M3CpE+vJqjb/RE53LZdtNYG2i/erK3lXug6jwzPSC7q39fvC7N8j061PTtNrN6fvj5sb71Z7X+qe/15PE05REhZXes9Zt6emRpTMAAAImSURBVCjPY2AY/IBRkgmnHDMjg6GEvoKJJJDNwS7EiCzHyStlaqxrGxHRZSThpeCrraOjgWSQkGdT98aNEyKAoLpoQdGqRQeXhQrCZVm1u1M2buzdDJLsn9bc2rqqtPhwCFyaXWvZxo0buzdFgCVbcleuPpq6XJOJgYNNRoYZaLPAlPnzMzdsqY7oagZKluXlrV68VIArwFvW3pqXgYFJcW5mZmZTXd30up0tZeV5eeW5Kw4d0FL14VexAUozyPcUFxdPWVw6pXT6gvK88rLcJUf2p6qr8POzaHIApQUdYlOnFBYWxsSULsot271nxb6splR1FhYWaSFwcInXAqViYoFgwuzZS2bOycnOWe7kzMInBQkdsR6gXGJiwsSpu2bumBOdk5OTNWOpKp+0BcRranaJQMmEqZMm127PBsplFRT0xZvzWbFCpAWV5ybEx0+eVBsTMyMHKFdVFd2ZbGapAYsPx4b4moaSiSAL+qqigaCjPU5JVg4WcC4Lk+O2NSYAjajpBMqtXV8ZlVYhwAmT5mqMm1WiFF+TnBzXvqaysq2tIjI9TJwZJi3nFjVva3JcXFxaWlQFUCo9PSwsQxEeK2zKs0oaQHJRkUBtYWHhQGAgj4hT13mNYCmgXHhSeFLGunw9MWZEMvPYuzASISXCwy3KhpSemNxLMoAmJmXUg6XYOdBSor9weFJ9vjAPNxc7K5b0yhYsHBjE5ceKKymzqXEyYpUAALU5uvKbCeLBAAAAAElFTkSuQmCC)
    }
    
  file-nav
    {width:100%;height:100%}
    
  .spc
    {flex:1}
    
  input
    {font-size:16px;padding:5px 10px}
  input[type=checkbox]
    {width:20px;height:20px;margin:0;cursor:pointer;box-sizing:border-box;}
    
            </style>
            
            <img class=icon src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAMAAAAM7l6QAAABYlBMVEVHcEwAAAAYFg0QDw8AAAEAAADSvV4DAgMBAQELEBAFAwQAAALMuFsBAQEICAfDsFfWwV8pJBTHtFm9q1UBAQEBAAAXHh3dyGMlND0LFREcOSanl0sjHxIJCAkEBAMaFw0CAwNHQCIPDQ4XMCGJfD8AAAMEBwUJBggBAAJZUCoBAAECAgIAAADm0GcxLBcAAADon48AAAB2TkvGhnpwZjR5bTirdGqyoVGCdjz/5nD/jbH/6nIODAf/7HPDsFf/53A+OB313WxHQCH54G7/6HH/j7QuGyBeViru12n842/8i7C2pFD+5W+QT2PHboqARlpULjr0h6r3321yPlCZikV2psAcERWgWG5iNUPqgaNGJzBcwoJ4/6tDPR9fhpqW0/Sd3f8/WWfn0We7Z4JJm2dBiFooWztcw4MoPkZbOzowRU+Szu00SFNSc4Q7ISl8r8nifZ1NbX42cEt09qRu6pzkzmVNb2+NAAAAV3RSTlMAZv4FXbT9I3HmM2D9h/L8/v7+/VVP/P7+8/7+/hTK8vf8DP78PuraRPynwJX+/qX9q/79+/3+/fz///////////////////////////////////////514g4cAAABsklEQVQoz3XTh1LCQBAG4HhICAgYunQEEXtvlxgDeIRQFEREml2wd31/L6BOCv4puzPfXMrOHEH8JDoToXAJ6iMWHaGJzhLreIcJwuV+Mhq0TLlb7WvjFOEcOxrApsnrdvvjPRT9h42xzmc3NvsPE6Y5342XMlGzYy/eZafWXb6W0WCyXhydnT4mgurF1Iyv5bXMRd7Ozx/uJy2uqEITTcF3A5rlcu307ELAhZLzyPPBlbsrvDL5Y/etsM8wJb18NkPNfP64fpVhsNf3M0xmT86GxdohTgkv60fBhtBJVkpawAu17Fy45CFOKl0axCPJSo/5bL3RaBzk8VHSB2Wc6jGqAkEQNlZXlu5q1hClUzHctRcKhS+Rlmo1HJczQohHHMexCEknmzsZkvEuTZKX8yRJzldo0pPDT0r/8nAyhcwBm21iKwACE3apK/IKZkfBpkcU/cCfcgDHuk3U8LQfsnZg5hygmpXepuK1QhH1eDs57eChmkkO9hmYIVJ/GjnuQRDR4zRrljoV8zkR/wyU7v1OxbA/N/7nUnKFxXNSJvfH8XB1RxN/eOpvf1m3NbH2duI3WLB5YemTat8AAAAASUVORK5CYII='>
            
            <div id=ftp-server class=menu style='display:none;left:45px;top:45px;width:600px;height:800px'>
            
                  <div class=menu-title>
                        ftp server
                  </div>
                  
                  <div id=server-root class=field>
                        <label>
                              server
                        </label>
                        <div class=spc></div>
                        <div>
                              <input value='quit' type=button>
                              <input value=download type=button>
                        </div>
                  </div>
                  
                  <div class=hr></div>
                  
                  <div id=proxy class=category>
                  
                        <div class=category-title>
                              proxy
                        </div>
                        
                        <div id=url-root class=field>
                              <label>
                                    url
                              </label>
                              <img class=copy>
                              <img class=paste>
                              <input id=url value='https://localhost:3000' class=value spellcheck=false autocomplete=off>
                        </div>
                        
                        <div id=auth-root class=field>
                              <label>
                                    auth
                              </label>
                              <input id=auth-chk type=checkbox checked>
                              <input id=auth value='matt-123' class=value spellcheck=false autocomplete=off >
                        </div>
                        
                  </div>
                  
                  <div class=hr></div>
                  
                  <div id=ftp class=category>
                  
                        <div class=category-title>
                              ftp
                        </div>
                        
                        <div id=host-root class=field>
                              <label>
                                    host
                              </label>
                              <img class=copy>
                              <img class=paste>
                              <input id=host value='192.168.8.212' class=value spellcheck=false autocomplete=off>
                        </div>
                        
                        <div id=port-root class=field>
                              <label>
                                    port
                              </label>
                              <img class=copy>
                              <img class=paste>
                              <input id=port value=2222 class=value spellcheck=false autocomplete=off>
                        </div>
                        
                        <div id=user-root class=field>
                              <label>
                                    user
                              </label>
                              <img class=copy>
                              <img class=paste>
                              <input id=user value='hello@example.com' class=value spellcheck=false autocomplete=off>
                        </div>
                        
                        <div id=password-root class=field>
                              <label>
                                    password
                              </label>
                              <img class=copy>
                              <img class=paste>
                              <input id=password value='hello@example.com' class=value spellcheck=false autocomplete=off>
                        </div>
                        
                        <div id=secure-root class=field>
                              <label>
                                    secure
                              </label>
                              <div class=value>
                                    <input id=secure type=checkbox>
                              </div>
                        </div>
                        
                        <div id=connect-root class=field>
                              <input value=connect type=button>
                              <input value=disconnect type=button>
                              <input value=status type=button>
                        </div>
                        
                  </div ftp>
                  
                  <div class=hr></div>
                  
                  <div id=btns>
                        <img id=parent-dir>
                        <input value=load type=button>
                        <input value=save type=button>
                        <input value=dir type=button>
                        <input value=mkdir type=button>
                        <div class=spc></div>
                        <input value=del type=button>
                  </div>
                  
                  <file-nav component v2.0></file-nav>
                  
            </div>
            
      </template>
      
      <script>
      
      
(function ftp_server({mod,dom,host}){

  var obj   = {
        version   : 'v2.0'
  };
  
        var df=false,did='ftp-server'
        ;
        
        var ext,$,datatype,menu,source,log
        ;
        
        obj.initmod   = function(params){
        
              ext           = mod.rd(params,'ext',ext);
              $             = mod.rd(params,'$',$);
              datatype      = mod.rd(params,'datatype',datatype);
              
              menu          = mod.rd(params,'menu',menu);
              source        = mod.rd(params,'source',source);
              
              log           = mod.rd(params,'log',log);
              
        }//initmod
        
        
  //vars:-
  
  
        var jszip;
        
        
        var filenav;
        
        var typename    = 'ftp-server';
        
        var url         = 'https://localhost:3001';
        var auth        = 'matt-123';
        
        var root;
        var shadow;
        var icon;
        var ui          = {};
        ui.root         = {};
        ui.item         = {};
        ui.rd           = {};
        ui.proxy        = {};
        ui.ftp          = {};
        
        var rd          = {};
        var btn         = {};
        btn.ftp         = {};
        var file        = {};
        var dir         = {};
        
        
        
        
  //:
  
  
        obj.init    = async function(){
                                                                                debug(obj.version);
                                                                                
              filenav                   = mod['file-nav'];
              
              filenav.initmod({ext,$,datatype});
              
              filenav.rd.params         = rd.params;
              filenav.file.click        = file.click;
              filenav.file.dblclick     = file.dblclick;
              
              await filenav.init();
              
              
        }//init
        
        
  //:
  
  
        obj.initdom   = function(){
        
              //root                                              = $.$(rootnode,'ftp-server');
              shadow                                            = host.shadowRoot;
              
              menu.add.style(shadow);
              
              var style                                         = $(shadow,'style');
              $.stylesheet.insert(style,'.icon');
              
              var node                                          = $(shadow,'.menu');
              icon                                              = $(shadow,'.icon');
              icon.onclick                                      = menu.click(node,'both',true,callback);
              menu.input.norm(node);
              
              
              
              ui.root.server                                    = $(node,'#server-root');
              
              $(ui.root.server,'[value=quit]').onclick          = btn.quit;
              $(ui.root.server,'[value=download]').onclick      = btn.download;
              
              
              ui.proxy.root                                     = $(node,'#proxy');
              
              $(node,'.copy').onclick                           = btn.copy;
              $(node,'.paste').onclick                          = btn.paste;
              
              ui.url                                            = $(node,'#url');
              if(url){
                    ui.url.value                                = url;
              }
              
              ui['auth-chk']                                    = $(node,'#auth-chk');
              ui.auth                                           = $(node,'#auth');
              if(auth){
                    ui.auth.value                               = auth;
              }
              
              
              
              ui.ftp.root                                       = $(node,'#ftp');
              
              ui.ftp.host                                       = $(ui.ftp.root,'#host');
              ui.ftp.port                                       = $(ui.ftp.root,'#port');
              ui.ftp.user                                       = $(ui.ftp.root,'#user');
              ui.ftp.password                                   = $(ui.ftp.root,'#password');
              ui.ftp.secure                                     = $(ui.ftp.root,'#secure');
              
              $(ui.ftp.root,'[value=connect]').onclick          = btn.ftp.connect;
              $(ui.ftp.root,'[value=disconnect]').onclick       = btn.ftp.disconnect;
              $(ui.ftp.root,'[value=status]').onclick           = btn.ftp.status;
              
              
              
              $(node,'[value=load]').onclick                    = btn.load;
              $(node,'[value=save]').onclick                    = btn.save;
              $(node,'[value=dir]').onclick                     = btn.dir;
              
              
              filenav.initdom(shadow);
              
              
        }//initdom
        
        
  //:
  
  
        rd.params   = function(){
        
              var url     = ui.url.value;
              var auth    = ui.auth.value;
              return {url,auth};
              
        }//params
        
        
  //:
  
  
        btn.quit    = async function(){
        
              var url   = ui.url.value;
              
              var res   = await fetch(url+'quit');
              var txt   = await res.text();
              
        }//quit
        
        
        btn.download    = async function(e){
        
              var zip   = {
                    'ftp-proxy-server'   :{directory:{
                          'package.json'          : {file:{github:{repo:'code',path:'/nodejs/server/ftp-proxy-server/package.json'}}},
                          'ftp-proxy-server.js'   : {file:{github:{repo:'code',path:'/nodejs/server/ftp-proxy-server/ftp-proxy-server.js'}}},
                    }}
              };
              
              create_archive(zip,{download:'ftp-proxy-server.zip',df:true});
              
        }//download
        
        
        btn.copy    = async function(){
        
              var txt   = ui.url.value;
              await navigator.clipboard.writeText(txt);
              
        }//copy
        
        
        btn.paste   = async function(){
        
              var txt         = await navigator.clipboard.readText();
              ui.url.value    = txt;
              
        }//paste
        
        
        btn.load    = function(){
                                                                                debug('btn.load');
              if(filenav.cur.type!=='file'){
                    alert('no file selected');
                    return;
              }
              
              var url         = ui.url.value;
              var path        = filenav.cur.path;
              var filename    = filenav.cur.filename;
                                                                                debug(url,path,filename);
              load.ui(url,path,filename);
              
        }//load
        
        
        btn.save    = async function(){
        
              if(filenav.cur.type!=='file'){
                    alert('no file selected');
                    return;
              }
              
              
              var url         = ui.url.value;
              var path        = filenav.cur.path;
              var filename    = filenav.cur.filename;
              
              save.ui(url,path,filename);
              
        }//save
        
        
        btn.dir   = function(){
        
              var url       = ui.url.value;
              var auth      = ui.auth.value;
              var path      = filenav.path;
                                                                                debug('btn.dir',url,auth,path);
              filenav.server.readdir(url,auth,path);
              
        }//dir
        
        
        
        btn.ftp.connect   = async function(){
        
              var host        = ui.ftp.host.value;
              var port        = ui.ftp.port.value;
              var user        = ui.ftp.user.value;
              var password    = ui.ftp.password.value;
              var secure      = ui.ftp.secure.checked;
                                                                                console.log(host,port,user,password,secure);
              var json        = {host,port,user,password,secure};
              var body        = JSON.stringify(json);
              
              var url         = ui.url.value;
              var auth        = ui.auth.value;
              
              var headers     = {auth,mode:'connect'};
              var err;
              try{
              
                    var res         = await fetch(url,{headers,method:'post',body});
                    
              }//try
              catch(err2){
              
                    err   = err2;
                    
              }//catch
              if(err){
                    var error   = err.toString();
                    log.red(error);
                    return;
              }
              
              var json    = await res.json();
              if(json.error){
                    log.red(json.error);
              }else{
                    log.green(json.ok);
              }
              
        }//connect
        
        
        btn.ftp.disconnect    = async function(){
        
              var url         = ui.url.value;
              var auth        = ui.auth.value;
              
              var headers     = {auth,mode:'disconnect'};
              
              var err;
              try{
              
                    var res         = await fetch(url,{headers});
                    
              }//try
              catch(err2){
              
                    err   = err2;
                    
              }//catch
              if(err){
                    var error   = err.toString();
                    log.red(error);
                    return;
              }
              
              var json    = await res.json();
              if(json.error){
                    log.red(json.error);
              }else{
                    log.green(json.ok);
              }
              
        }//desconnect
        
        
        btn.ftp.status    = async function(){
        
              var url         = ui.url.value;
              var auth        = ui.auth.value;
              
              var headers     = {auth,mode:'status'};
              
              var err;
              try{
              
                    var res         = await fetch(url,{headers});
                    
              }//try
              catch(err2){
              
                    err   - err2;
                    
              }//catch
              if(err){
                    var error   = err.toString();
                    log.red(error);
                    return;
              }
              
              var json    = await res.json();
              if(json.error){
                    log.red(json.error);
              }else{
                    log.green(json.ok);
              }
              
        }//status
        
        
  //:
  
  
        function callback(){
        
              console.log('menu.callback');
              
        }//callback
        
        
        file.click    = function(path,filename){
                                                                                debug('file.click',path,filename);
        }//click
        
        
        file.dblclick   = function(path,filename){
                                                                                debug('file.dblclick',path,filename);
              var url   = ui.url.value;
              load.ui(url,path,filename);
              
        }//dblclick
        
        
  //:
  
  
        load.ui   = async function(url,path,filename){
                                                                                debug('load.ui',url,path,filename);
              var title       = `${url}\n${path}\n${filename}`;
              
/*
              var file            = filemod.new({
              
                    filetype    : filetype,
                    abs         : path,
                    path        : path,
                    name        : filename,
                    
                    kind        : 'file',
                    size        : null,
                    ctime       : null,
                    mtime       : null,
                    atime       : null,
                    
                    title       : title,
                    icon        : icon.src
                    
              });
              
              file.url    = url;
              
*/

              var file        = {};
              file.type       = typename;
              file.url        = url;
              file.path       = path;
              file.filename   = filename;
              file.name       = filename;
              file.title      = title;
              file.icon       = icon.src;
              
              var result      = await load(file);
              if(result===false){
                     return;
              }
              var blob    = result;
              
              obj.load.complete(file,blob);
              
        }//ui
        
        
        obj.load    = function(file){return load(file)}   //d
        
        async function load(file){
                                                                                debug('load');
                                                                                debug(file);
              var url         = file.url;
              var path        = file.path;
              var filename    = file.filename;
              var full        = url+path+filename;
                                                                                debug('load',full);
              var result    = await loadfile(full);
              if(result===false){
                    return false;
              }
              var blob   = result;
              
              return blob;
              
        }//load
        
        
        save.ui   = async function(url,path,filename){
        
              var title       = `${url}\n${path}\n${filename}`;
              
/*
              var file            = filemod.new({
              
                    filetype    : filetype,
                    abs         : path,
                    path        : path,
                    name        : filename,
                    
                    kind        : 'file',
                    size        : null,
                    ctime       : null,
                    mtime       : null,
                    atime       : null,
                    
                    title       : title,
                    icon        : icon.src
                    
              });
              
              file.url    = url;
              
*/

              var file            = {};
              
              file.type           = typename;
              file.url            = url;
              file.path           = path;
              file.filename       = filename;
              file.name           = filename;
              file.title          = title;
              file.icon           = icon.src;
              
              
              var blob        = await source();
              
              var result      = await save(file,blob);
              if(result===false){
                    return;
              }
              
              //obj.save.complete ?
              
        }//ui
        
        
        obj.save    = function(file,blob){return save(file,blob)}   //d
        
        async function save(file,blob){
        
              var url         = file.url;
              var path        = file.path;
              var filename    = file.name;
              var full        = url+path+filename;
                                                                                //console.log('save',full);
              var result    = await savefile(full,blob);
              if(result===false){
                    return false;
              }
              
              obj.save.complete(file);
              
              return true;
              
        }//save
        
        
        obj.clear   = function(){
        }//clear
        
        
        obj.export    = function(cur){
        
              var file        = {};
              file.type       = typename;
              file.path       = cur.url;
              return file;
              
        }//export
        
        
  //:
  
  
        async function loadfile(url){
        
              var headers     = {mode:'load'};
              
              if(ui['auth-chk'].checked){
                    var auth        = ui.auth.value;
                    headers.auth    = auth;
              }
              
              var err;
              try{
              
                    var res         = await fetch(url,{headers});
                    
              }//try
              catch(err2){
              
                    err   = err2;
                    
              }//catch
              if(err){
                    alert('ftp-server.loadfile error\n'+err.toString());
                    return;
              }
              
              if(!res.ok){
                    var txt         = await res.text();
                    alert('loadfile : '+url+'\n'+txt);
                    return false;
              }
              
              var blob    = await res.blob();
              return blob;
              
        }//loadfile
        
        
        async function savefile(url,blob){
        
              var headers   = {mode:'save'};
              
              if(ui['auth-chk'].checked){
                    var auth        = ui.auth.value;
                    headers.auth    = auth;
              }
              
              var body      = blob;
              
              var err;
              try{
              
                    var res       = await fetch(url,{method:'post',headers,body});
                    
              }
              catch(err2){
              
                    err   = err2;
                    
              }
              if(err){
                    alert('ftp-server.savefile error\n'+err.toString());
                    return;
              }
              
              if(!res.ok){
                    var txt       = await res.text();
                    alert('savefile : '+url+'\n'+txt);
                    return false;
              }
              
              var blob    = await res.blob();
              return blob;
              
        }//save
        
        
  //:
  
  
        build.path    = function(type,path,filename){
        
              var parts   = new URL(ui.url.value);
              var url     = parts.protocol+'//'+parts.host+path;
              
              if(filename){
                    if(type=='dir'){
                          if(!filename.endsWith('/')){
                                filename   += '/';
                          }
                    }
                    url  += filename;
              }
              
              return url;
              
        }//path
        
        
        function build(url,cwd){
        
              console.log(cwd);
              
              var p       = new URL(url);
              var url2    = p.protocol+'//'+p.host+cwd;
              return url2;
              
        }//build
        
        
        
  //:
  
  
  
        async function create_archive(dir,{download=true,test,df=false}={}){
                                                                                df && console.log('download',download);
                                                                                df && console.log('test',!!test);
                                                                                df && console.json(dir);
                                                                                df && console.log();
              if(!jszip){
                    jszip   = await import('https://cdn.jsdelivr.net/npm/jszip/+esm');
                    jszip   = jszip.default;
              }
              
              var zip;
              if(!test){
                    zip   = new jszip();
              }
              
              var resolve,promise=new Promise(res=>resolve=res);
              var ct=0,total=0;
              add(dir);
              await promise;
              
              var blob;
              if(zip){
                    blob      = await zip.generateAsync({type:'blob'});
                    
                    if(download){
                          var url       = window.URL.createObjectURL(blob);
                          var a         = document.createElement('a');
                          a.download    = download;
                          a.href        = url;
                          a.click();
                    }
              }
              return blob;
              
              
              async function add(dir,abs=''){
              
                    for(let key in dir){
                    
                          ct++;
                          var o   = dir[key];
                          
                          if(o.directory){
                                                                                df && console.log('dir :',abs+key);
                                if(zip){
                                      zip.folder(abs+key);
                                }
                                add(o.directory,abs+key+'/');
                                complete();
                          }
                          
                          if(o.file?.contents){
                                                                                df && console.log('file create :',abs+key);
                                if(zip){
                                      zip.file(abs+key,o.file.contents);
                                }
                                complete();
                          }
                          
                          if(o.file?.github){
                                var owner,repo,branch,path;
                                if(typeof o.file.github=='string'){
                                      path    = o.file.github;
                                }else{
                                      ({owner,repo,branch,path}    = o.file.github);
                                }
                                owner     ||= 'javascript-2020';
                                repo      ||= 'libs';
                                branch    ||= 'main';
                                if(path.startsWith('/')){
                                      path    = path.slice(1);
                                }
                                                                                df && console.log('file github :',abs+key);
                                                                                df && console.log(owner,repo,branch,path);
                                if(zip){
                                      fetch(`https://raw.githubusercontent.com/${owner}/${repo}/${branch}/${path}`)
                                        .then(res=>res.text().then(txt=>{
                                        
                                              zip.file(abs+key,txt);
                                              complete();
                                              
                                        }));
                                }
                          }
                          
                          
                    }//for
                    
                    
                    function complete(){
                    
                          total++;
                          if(ct==total){
                                resolve();
                          }
                          
                    }//complete
                    
              }//add
              
              
              
        }//create_archive
        
        
        
  //:
  
  
        function debug(...args){
        
              if(!df && !obj.df)return;
              args.unshift(`[ ${did} ]`);
              var fmt     = Array.from({length:args.length}).fill('%O').join(' ');
              var args2   = [fmt].concat(args);
              console.groupCollapsed.apply(console,args2);
              console.trace();
              console.groupEnd();
              
        }//debug
        
        
        
        
        
        
        
        
        
        
        
  return obj;
  
})//ftp_server

      </script>
      
</ftp-server>



