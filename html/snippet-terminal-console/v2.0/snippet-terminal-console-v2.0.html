


<snippet-terminal-console v2.0>

      <template shadowrootmode=open>
      
            <link rel=stylesheet href='https://cdn.jsdelivr.net/npm/@xterm/xterm@5.5.0/css/xterm.css'>
            
            <style>
            
/*
  editor-root
    {display:block;height:200px}
  terminal-root::part(terminal)
    {height:200px}
*/

  #root
    {display:flex;flex-direction:column;gap:10px;border:1px solid lightgray;padding:10px;border-radius:5px}
    
  #btns
    {display:flex;gap:10px;margin:0 20px}
    
  .spc
    {flex:1}
  input
    {font-size:16px;padding:5px 10px;box-sizing:border-box;}
  input[type=button]
    {cursor:pointer}
    
            </style>
            
            
            <div id=root>
            
                  <div>
                        <file-mod component></file-mod>
                  </div>
                  
                  <web-editor component></web-editor>
                  
                  <div id=btns>
                        <input value=run type=button>
                        <div class=spc></div>
                        <input value=clear type=button>
                        <input value=reset type=button>
                  </div>
                  
                  <web-terminal component v2.0></web-terminal>
                  
                  <web-console component></web-console>
                  
            </div>
            
      </template>
      
      
      <script>
      
      
(function snippet_terminal_console({mod,dom,host}){

  var obj   = {
        version   : 'v2.0',
  };
  
        var df=true,did='snippet-terminal-console'
        ;
        
        
        
        var ext,$,menu,ace,log,config={}
        ;
        
        obj.initmod   = function(params){
        
              ext           = mod.rd(params,'ext',ext);
              $             = mod.rd(params,'$',$);
              menu          = mod.rd(params,'menu',menu);
              ace           = mod.rd(params,'ace',ace);
              obj.on        = mod.rd(params,'on',obj.on);
              log           = mod.rd(params,'log',log);
              
        }//initmod
        
        
  //:
  
  
        obj.on    = {};
        
        var filemod;
        obj.filemod       = null;
        var editor;
        obj.editor        = null;
        var terminal;
        obj.terminal      = null;
        var jsconsole;
        obj.console       = null;
        
        
        var src;
        
        var sandbox;
        var iframe;
        
        var def;
        var mode;
        
        
        var rd    = {};
        rd.attr   = {};
        var btn   = {};
        obj.btn   = {};
        var run   = {};
        obj.run   = run;
        
        
  //:
  
  
        obj.init    = async function(){
                                                                                debug('init',obj.version);
              var dom_config            = mod.rd.config(dom);
              config                    = Object.assign(config,dom_config);
              
              config['web-editor']      = mod.rd.attr(dom,'web-editor',config);
              config['web-terminal']    = mod.rd.attr(dom,'web-terminal',config);
              config['web-console']     = mod.rd.attr(dom,'web-console',config);
              
              if(!('fullsize' in config['web-editor'])){
                    config['web-editor'].fullsize    = true;
              }
                                                                                debug('config',config);
                                                                                
                                                                                
              def               = $.htmlentities.decode(dom);
              
              rd.attr.type();
              rd.attr.mode();
              
              
              
              filemod           = mod['file-mod'];
              obj.filemod       = filemod;
              editor            = mod['web-editor'];
              obj.editor        = editor;
              terminal          = mod['web-terminal'];
              obj.terminal      = terminal;
              jsconsole         = mod['web-console'];
              obj.console       = jsconsole;
              
              
              filemod.initmod({ext,$,menu,menumod,source,complete,log});
              editor.initmod({ext,$,menu,ace,config:config['web-editor'],mode});
              terminal.initmod({ext,$,config:config['web-terminal']});
              jsconsole.initmod({ext,$,menu,ace,config:config['web-console']});
              
              
              await Promise.all([
                    rd.attr.src(),
                    libs(),
                    filemod.init(),
                    editor.init(),
                    terminal.init(),
                    jsconsole.init(),
              ]);
              
              
        }//init
        
        
        async function libs(){
        
              [sandbox]       = await ext.load.libs('js/sandbox/sandbox.js.api');
              
        }//libs
        
        
        rd.attr.src    = async function(){
        
              if(!dom.hasAttribute('src'))return;
              
              src       = dom.getAttribute('src');
              var res   = await fetch(src);
              var txt   = await res.text();
              def       = txt;
              
        }//src
        
        
        rd.attr.mode    = function(){
        
              if(!dom.hasAttribute('mode'))return;
              
              mode    = dom.getAttribute('mode');
              
        }//mode
        
        
        rd.attr.type    = function(){
        
              if(!dom.hasAttribute('type'))return;
              
              mode    = dom.getAttribute('type');
                                                                                debug('deprecated [type]',mode);
        }//type
        
        
  //:
  
  
        obj.initdom   = async function(){
                                                                                debug('initdom');
              shadow                                = host.shadowRoot;
              
              filemod.initdom();
              
              editor.initdom({mode,txt:def,fullsize:true});
              editor.filename(src);
              
              
              $(shadow,'[value=run]').onclick       = btn.run;
              $(shadow,'[value=clear]').onclick     = btn.clear;
              $(shadow,'[value=reset]').onclick     = btn.reset;
              
              
              terminal.initdom();
              jsconsole.initdom(shadow);
              
              
              
        }//initdom
        
        
  //:
  
  
        btn.run   = async function(){
        
              var result;
              if(obj.btn.run){
                    result    = await obj.btn.run();
                    if(result===false){
                          return;
                    }
              }
                                                                                debug('run');
              var js;
              if(typeof result=='string'){
                    js    = result;
              }else{
                    js    = editor.getvalue();
              }
                                                                                //console.log(js);
              if(mode==='nodejs'||mode==='node-js'){
                    run.nodejs({js});
              }else{
                    run.browser({js});
              }
              
        }//btn.run
        
        
        btn.clear   = function(){
        
              window.console.clear();
              terminal.clear();
              jsconsole.clear();
              
        }//clear
        
        
        btn.reset   = function(){
                                                                                debug('reset');
              editor.setvalue(def);
              
        }//reset
        
        
        
  //:
  
  
        run.browser   = async function({js}){
                                                                                debug('run.browser');
              var result,error;
              result    = await sandbox.run.iframe(js,{console:jsconsole,ctx:{terminal},iframe});
              ({iframe,result,error}    = result);
              
        }//browser
        
        
        run.nodejs    = async function({js,on}){
                                                                                debug('run.nodejs');
              on    ||= obj.on;
              await sandbox.nodejs(js,{console:jsconsole,ctx:{terminal},on});
              
        }//nodejs
        
        
  //:
  
  
        function source(){
        
              var txt     = editor.getvalue();
              var blob    = new Blob([txt]);
              return blob;
              
        }//source
        
        
        function complete(file){
        }//complete
        
        
        complete.load   = function(file,blob){
        }//load
        
        
        complete.save   = function(file){
        
              (log||window.log)?.green(file.name+' saved');
              
        }//save
        
        
  //:
  
  
        function debug(...args){
        
              if(!df && !obj.df)return;
              args.unshift(`[ ${did} ]`);
              var fmt     = Array.from({length:args.length}).fill('%O').join(' ');
              var args2   = [fmt].concat(args);
              window.console.groupCollapsed.apply(window.console,args2);
              window.console.trace();
              window.console.groupEnd();
              
        }//debug
        
        
  return obj;
  
//snippet_terminal_console
})


      </script>
      
      
</snippet-terminal-console>




