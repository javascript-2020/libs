


<snippet-html-console>


      <template shadowrootmode=open>
      
            <style>
    
  #root
    {display:flex;flex-direction:column;gap:10px;border:1px solid lightgray;padding:10px;border-radius:5px;
      /*height:100%*/
    }
    
  #hldr
    {border:1px solid lightgray;}
    
  iframe
    {width:100%;height:100%;border:none}
    
  input
    {font-size:16px;padding:5px 10px}
  input[type=button]
    {cursor:pointer}
    
            </style>
            
            <div id=root>
            
                  <editor component v2.0></editor>
                  
                  <div>
                        <input value=run type=button>
                  </div>
                              
                  <div id=hldr>
                        <iframe></iframe>
                  </div>
                  
                  <console component v2.0></console>
                  
            </div>
      
      </template>
      
      
      <script>

      
(function snippet_html_console({mod,root,node}){

  var obj   = {
        version   : 'v2.0',
  };
  
        var df=true,did='snippet-html'
        ;
        
        
        var ext,$,source
        ;
        
        obj.initmod   = function(params){
        
              ext       = params.ext;
              $         = params.$;
              source    = params.source;
              
        }//initmod
        
        
  //:
  
        var editor;
        obj.editor    = null;
        var console;
        obj.console   = null;

        
        var host;
        var root;
        
        var hldr;
        var iframe;
        
        var def   = decode(root.innerHTML);
        
        var btn     = {};
        
        
  //:
  
  
        obj.init    = async function(){
                                                                                debug('init',obj.version);

              
              editor            = mod.editor;                                                                                
              obj.editor        = editor;
              console           = mod.console;
              obj.console       = console;

              
              editor.initmod({ext,$,menu,ace});
              console.initmod({ext,$});
              

              await Promise.all([  
                    src(),
                    editor.init(),
                    console.init(),
              ]);
              
              
        }//init


        async function src(){
          
              if(!root.hasAttribute('src'))return;
              var src   = root.getAttribute('src');
              var res   = await fetch(src);
              var txt   = await res.text();
              def       = txt;
              
        }//src
        

  //:
  
  
        obj.initdom   = function(rootnode){

              host                                = $.full('snippet-html-console',rootnode);
              root                                = host.shadowRoot;


              editor.initdom(root);
              
              
              $(root,'[value=run]').onclick       = btn.run;


              hldr                                = $(root,'#hldr');
              iframe                              = $(hldr,'iframe');


              console.initdom(root);
              console.log('hello');

        
        }//initdom
        
        
  //:

  
        btn.run   = run;
        obj.run   = run;
        
        function run(){
        
              hldr.replaceChildren();
              
              var html          = editor.getvalue();
              html              = sandbox+html;
              
              var niframe       = iframe.cloneNode(true);
              niframe.log       = log;
              niframe.srcdoc    = html;
              niframe.onload    = onload;
              hldr.append(niframe);
              
              
              function onload(){
              
                    var h   = niframe.contentDocument.documentElement.scrollHeight;
                    hldr.style.height   = h+'px';
                    
              }//onload
              
              
              function log(){
                
                    var args    = [...arguments];
                    args.unshift('[ snippet-html-console ]');
                    window.console.log.apply(window.console,args);
                    console.log.apply(console,arguments);
                    
              }//log
              
        }//run
        
        
        var sandbox   = `
        
              <script>
              
                    var source    = window.console;
                    
                    window.console.log    = window.frameElement.log;
                    
                    console.log(123);
                    
              </scr`+`ipt>
              
        `;
  
  //:
  

        function decode(str){
          
              var txt         = document.createElement('textarea');
              txt.innerHTML   = str;
              var html        = txt.value;
              return html;
              
        }//decode

        
        function encode(str){
          
              const div         = document.createElement('div');
              div.textContent   = str;
              var entities      = div.innerHTML;
              return entities;
              
        }//encode

  
  //:
  
        
        function debug(){
          
              if(!df && !obj.df)return;
              var str   = [...arguments].join(' ');
              window.console.log(`[ ${did} ]`,str);
              
        }//debug


  
  return obj;
  
})//snippet_html_console


      </script>

      
</snippet-html-console>