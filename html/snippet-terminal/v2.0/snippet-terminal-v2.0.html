


<snippet-terminal v2.0>

      <template shadowrootmode=open>

            <link rel=stylesheet href='https://cdn.jsdelivr.net/npm/@xterm/xterm@5.5.0/css/xterm.css'>
      
            <style>

/*            
  editor-root
    {display:block;height:200px}
  terminal-root::part(terminal)
    {height:200px}
*/    
    
  #root
    {display:flex;flex-direction:column;gap:10px;border:1px solid lightgray;padding:10px;border-radius:5px}
    
  #btns
    {}

  input
    {font-size:16px;padding:5px 10px;box-sizing:border-box;}
  input[type=button]
    {cursor:pointer}
    
            </style>
            
            
            <div id=root>
            
                  <div>
                        <file-mod component></file-mod>
                  </div>
                  
                  <web-editor component></web-editor>
                  
                  <div id=btns>
                        <input value=run type=button>
                        <input value=clear type=button>
                  </div>
                  
                  <web-terminal component></web-terminal>
                  
            </div>
            
      </template>
      
      
      <script>

      
(function snippet_terminal({mod,dom,host}){

  var obj   = {
        version   : 'v2.0',
  };
  
        var df=true
        ;
        
        var ext,$,menu,ace,menumod
        ;
        
        obj.initmod   = function(params){
              
              ext           = params.ext;
              $             = params.$;
              
              menu          = params.menu;
              menumod       = params.menumod;
              
              ace           = params.ace;
              
        }//initmod
        
        
  //:

        
        var filemod;
        obj.filemod     = null;
        var editor;
        obj.editor      = null;
        var terminal;
        obj.terminal    = null;
        
        var src;
        
        var sandbox;
        var iframe;
        
        var def;
        var mode;

        
        var rd            = {};
        var btn           = {};

        
  //:
  
  
        obj.init    = async function(){

              def               = $.htmlentities.decode(dom);
              mode              = dom.getAttribute('type');


              filemod           = mod['file-mod'];
              obj.filemod       = filemod;
              editor            = mod['web-editor'];
              obj.editor        = editor;
              terminal          = mod['web-terminal'];
              obj.terminal      = terminal;              

              filemod.initmod({ext,$,menu,menumod,source,complete});
              editor.initmod({ext,$,menu,ace});
              terminal.initmod({ext,$});
              
              await Promise.all([
                    rd.src(),
                    libs(),
                    filemod.init(),
                    editor.init(),
                    terminal.init()
              ]);

              
        }//init
        
        
        async function libs(){
          
              [sandbox]       = await ext.load.libs('js/sandbox/sandbox.js.api');
          
        }//libs
        
        
        rd.src    = async function(){
          
              if(!dom.hasAttribute('src'))return;
              src       = dom.getAttribute('src');
              var res   = await fetch(src);
              var txt   = await res.text();
              def       = txt;
              
        }//src
        
        
  //:
  
  
        obj.initdom   = async function(){
          
              shadow                              = host.shadowRoot;

              filemod.init();
              
              editor.initdom({mode:'js',txt:def,fullsize:true});
              editor.filename(src);
              
              $(shadow,'[value=run]').onclick       = btn.run;
              $(shadow,'[value=clear]').onclick     = btn.clear;
              
              terminal.initdom();
                            
        }//initdom
        
        
  //:


        btn.run   = async function(){
          
              var js    = editor.getvalue();
              
              var console     = {};
              console.write   = function(){
                              
                                      window.console.log.apply(window.console,arguments);
                                      terminal.write.apply(null,arguments);
                                      
                                }//write
              console.log     = function(){
                              
                                      window.console.log.apply(window.console,arguments);
                                      terminal.writeln.apply(null,arguments);
                                      
                                }//log
              console.clear   = function(){
                  
                                      window.console.clear();
                                      terminal.clear();
                                      
                                }//clear
              console.error   = function(err){
                                
                                      window.console.error.apply(window.console,arguments);
                                      terminal.error.apply(null,arguments);
                                      
                                }//error
              console.warn    = function(){
                
                                      window.console.warn.apply(window.console,arguments);
                                      terminal.warn.apply(null,arguments);
                                      
                                }//warn
                                
              console.debug   = function(){
                
                                      window.console.debug.apply(window.console,arguments);
                                      terminal.debug.apply(null,arguments);
                                      
                                }//debug
              
              var result,error;
              if(mode=='nodejs'){
                    ({result,error}   = await sandbox.nodejs(js,{console}));
              }else{
                    ({iframe,result,error}    = await sandbox.run.iframe(js,{console,ctx:{terminal},iframe}));
              }
                    
              
              
        }//btn.run
        

        btn.clear   = function(){
          
              window.console.clear();
              terminal.clear();
              
        }//clear


  //:
  
  
        function source(){
          
              var txt     = editor.getvalue();
              var blob    = new Blob([txt]);
              return blob;
              
        }//source
        
        
        function complete(file){
        }//complete
        
        
        complete.load   = function(file,blob){
        }//load

        
        complete.save   = function(file){
          
              (log||window.log)?.green(file.name+' saved');
              
        }//save
        
        
        
  
  return obj;
  
})//snippet_terminal


      </script>
      
</snippet-terminal>




