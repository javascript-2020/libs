

<local-file v2.0>

      <template shadowrootmode=open>
      
            <style>
            
  .icon
    {}
  .menu
    {position:absolute;left:0;top:35px}
  .spc
    {height:10px}
    
            </style>
            
            <img class=icon style='padding:2px' src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAMAAAAM7l6QAAAAxlBMVEVHcExiaoE9SGZ7gpc9R2VdZH11fJIwO1t6gpd4f5OJj6Jyeo8vOlqWm6xqcohmboVIUm4kLUwgLE5iaoJOV3J5gZZ8g5cwO1uFi589R2VkbIRFT2xSW3Z1fJKfpLK53v283/7B4fzH5P6IjqCLoLvKzdSzt8GNkqXM5v5/jaXGytGSmKl8iqN7gpeBh5yy1vWw1POdu9qlq7eanq54f5SeobB8hpi3usS62POCkKdcZH2GnLi/w8t/TWWWs9KViptmhYWpzOvv7VDoAAAAH3RSTlMAm0XUZ7f4Mfrd8Nwk+ZydXwUVvpz62Vf0Nt5+r+T7dypHKgAAARtJREFUKM/dkutOgzAYQBkgqEOBwS5eoSDlMuiQO3M6ff+Xsl9ZQY3/TTxp0jYnOQ20gvBfMfRrQDe0mT77iSHM6y1QSzJJY04f930cp+RMmGchtX4lycu3XT7QdR3q8vwjBZ01TVNlknz+7DoM5KHIo/OO6ovSB+pJux7yIvekpzjXYJHDdZURQrIpztO/x2k6ipxR0zhlio9pHm8gzjVCiNshjgsAD9odD+Y6CdpjGyRMj9/0VZevNWjSPw288Llh+lAfQD+2mNK2xb5mK9xiC3TxXlC9frgE/JDss9DfwHpjM93gIFlpmkpZKyWwtWGjLkAHMFYLuH31TgnZf7gXTfYcrKsBC7RpKyeWtxrTmjjwfSeKN+Zfv+NPY7M/3PrlSFEAAAAASUVORK5CYII='>
            
            <div class=menu style='display:none'>
                  <div class=menu-title>local file</div>
                  <div id=load class=menu-opt>load</div>
                  <div id=save class=menu-opt>save</div>
                  <div class=spc></div>
                  <div id=download class=menu-opt>download</div>
                  <div class=spc></div>
                  <div id=clear class=menu-opt>clear filename</div>
            </div>
            
      </template>
      
      <script>
      
      
(function local_file({mod,dom,host}){

  var obj   = {
        version   : 'v2.0'
  };
  
        var df=false,did='localfile'
        ;
                                                                                debug(obj.version);
        var $,menu,filemod,source
        ;
        
        obj.initmod   = function(params){
        
              $         = mod.rd(params,'$',$);
              
              menu      = mod.rd(params,'menu',menu);
              
              filemod   = mod.rd(params,'filemod',filemod);
              source    = mod.rd(params,'source',source);
              
        }//initmod
        
        
  //vars:-
  
        var cur;
        
        var root;
        var shadow;
        
        var icon;
        
        
        obj.load    = {};
        obj.save    = {};
        
        
  //:
  
  
        obj.init    = function(){
        }//init
        
        
  //:
  
  
        obj.initdom   = function(){
        
              //var root          = $.$(rootnode,'localfile-root');
              shadow            = host.shadowRoot;
              
              menu.add.style(shadow);
              
              var style         = $(shadow,'style');
              $.stylesheet.insert(style,'.icon');
              
              
              var card          = $(shadow,'.menu');
              
              icon              = $(shadow,'.icon');
              icon.onclick      = menu.click(card,false,false,click);
              
              
        }//initdom
        
        
  //:
  
  
        function click(type,opt){
        
              if(type=='opt'){
                    click[opt.id]();
              }
              
        }//menu
        
        
        click.load   = async function(){
        
              var {file,blob}   = await loadfile();
              cur               = file.filename;
              
              obj.load.complete(file,blob);
              
        }//load
        
        
        click.save   = async function(){
        
              var filename    = 'file.txt';
              if(cur){
                    filename    = cur;
              }
              
              var blob    = source();
              
              var file    = await savefile(filename,blob);
              
              obj.save.complete(file,false);
              
        }//save
        
        
        click.download   = async function(){
        
              var filename    = 'file.txt';
              var file        = filemod?.cur;
              if(file){
                    filename    = file.filename;
              }
              var blob         = source();
              savefile(filename,blob);
              
        }//download
        
        
        click.clear    = function(){
        
              cur   = 'file.txt';
              menumod.close();
              
        }//clear
        
        
  //:
  
  
        obj.load    = function(file){return load(file)}
        
        async function load(file){
        
              var {file,blob}   = await loadfile();
              
              obj.load.complete(file,blob);
              
              return txt;
              
        }//load
        
        
        obj.save    = function(file,blob){return save(file,blob)}
        
        async function save(file,blob){
        
              var filename    = file.filename;
              var result      = await savefile(filename,blob);
              if(result===false){
                    return;
              }
              
              obj.save.complete(file,false);
              
        }//save
        
        
        obj.clear   = function(){
        }//clear
        
        
  //:
  
  
        function loadfile(){
        
              var resolve,promise=new Promise(res=>resolve=res);
              
              var input         = document.createElement('input');
              input.type        = 'file';
              input.onchange    = onchange;
              input.oncancel    = oncancel;
              input.click();
              
              return promise;
              
              
              async function onchange(){
              
                    var blob        = input.files[0];
                    
                    var filename    = blob.name;
                    var path        = 'localfile : '+filename;
                    var title       = path;
                    
/*
              var file            = filemod.new({
              
                    filetype    : 'localfile',
                    abs         : path,
                    path        : path,
                    name        : filename,
                    
                    kind        : 'file',
                    size        : null,
                    ctime       : null,
                    mtime       : null,
                    atime       : null,
                    
                    title       : title,
                    icon        : icon.src
                    
              });
              
              file.url    = url;
              
*/

                    var file        = {};
                    file.type       = 'localfile';
                    
                    file.filename   = filename;
                    file.name       = filename;
                    file.path       = path;
                    
                    file.title      = path;
                    file.icon       = icon.src;
                    
                    
                    resolve({file,blob});
                    
              }//onchange
              
              
              function oncancel(){
              }//oncancel
              
        }//loadfile
        
        
        function savefile(filename,blob){
        
              var url       = window.URL.createObjectURL(blob);
              var a         = document.createElement('a');
              a.href        = url;
              a.download    = filename;
              a.click();
              
              
/*
              var title           = file.path;
              
              var file            = filemod.new({
              
                    filetype    : 'localfile',
                    abs         : path,
                    path        : path,
                    name        : filename,
                    
                    kind        : 'file',
                    size        : null,
                    ctime       : null,
                    mtime       : null,
                    atime       : null,
                    
                    title       : title,
                    icon        : icon.src
                    
              });
              
              file.url    = url;
              
*/


              var file        = {};
              
              file.type       = 'localfile';
              file.filename   = filename;
              file.name       = filename;
              file.path       = 'localfile : '+filename;
              file.title      = file.path;
              file.icon       = icon.src;
              
              return file;
              
              
        }//savefile
        
        
  //:
  
  
        function debug(){
        
              if(!df && !obj.df)return;
              
              var str   = [...arguments.join(' ')];
              console.log(`'[ ${did} ]`,str);
              
        }//debug
        
        
        
        
  return obj;
  
})//local-file

      </script>
      
</local-file>




