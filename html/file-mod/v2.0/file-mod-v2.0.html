

<file-mod v2.0>

      <template shadowrootmode=open>
      
            <style>

  :host
    {all:initial;font-family:arial}
  
    
  #root 
    {display:inline-flex;gap:5px;margin-right:5px;position:relative}

  .icon
    {border:1px solid gray;border-radius:3px;box-sizing:border-box;width:30px;height:30px;cursor:pointer}
    

  localfile
    {}    
  github-root
    {}        
  https-file
    {}
  db-files
    {}
  google-storage
    {}
    
            </style>

            
            <div id=root style='visibility:hidden'>
            
                  <local-file component></local-file>
                  <file-server component></file-server>
                  <github-ui component></github-ui>
                  <db-files component></db-files>
                  <google-storage component></google-storage>
                  <ftp-server component></ftp-server>
                  
            </div>

            
      </template>
      
      <script>


      
(function filemod({mod,dom,host}){
  
  var obj       = {
        version   : 'v1.0'
  };
  
        var df    = true
        ;
                                                                                
        var ext,$,menumod,menu,complete,source,focus,editor,log
        ;
          
        obj.initmod   = function(params){
          
              ext             = params.ext;
              $               = params.$;
              menumod         = params.menumod;
              
              menu            = params.menu;
              complete        = params.complete;
              source          = params.source;
              focus           = params.focus;
              log             = params.log;
              
              editor          = params.editor;
              
        }//initmod


  //vars:-
        
        var localfile;
        var github;
        var fileserver;
        var dbfiles;
        var googlestorage;
        var ftpserver;
        
        var cur;
        Object.defineProperty(obj,'cur',{get:()=>cur,set:v=>cur=v});


        var root;
        var shadow;

        
        var btn   = {};

          
  //:

              
        obj.init    = async function(){
                                                                                //debug(obj.version);
            
            if(!menumod){
                  menumod   = menu.menumod;
            }
            
            
            localfile                 = mod['local-file'];
            obj.localfile             = localfile;
            
            fileserver                = mod['file-server'];
            obj.fileserver            = fileserver;
            
            github                    = mod['github-ui'];
            obj.github                = github;
            
            dbfiles                   = mod['db-files'];
            obj.dbfiles               = dbfiles;
            
            googlestorage             = mod['google-storage'];
            
            ftpserver                 = mod['ftp-server']


            localfile.initmod({ext,$,menu,filemod:obj,source});
            fileserver.initmod({ext,$,menu,filemod:obj,source});
            github.initmod({ext,$,menu,filemod:obj,source});
            dbfiles.initmod({ext,$,datatype,menumod,menu,filemod:obj,source});
            googlestorage.initmod({ext,$,menumod,menu,filemod:obj,source});
            ftpserver.initmod({ext,$,datatype,menu,source,log});

            await Promise.all([
                  localfile.init(),
                  fileserver.init(),
                  github.init(),
                  dbfiles.init(),
                  googlestorage.init(),
                  ftpserver.init(),
            ]);
            
            complete                        ||= {};
            localfile.load.complete           = complete.load;
            localfile.save.complete           = complete.save;
            fileserver.load.complete          = complete.load;
            fileserver.save.complete          = complete.save;
            github.load.complete              = complete.load;
            github.save.complete              = complete.save;
            dbfiles.load.complete             = complete.load;
            dbfiles.save.complete             = complete.save;
            googlestorage.load.complete       = complete.load;
            googlestorage.save.complete       = complete.save;
            ftpserver.load.complete           = complete.load;
            ftpserver.save.complete           = complete.save;


            
        }//init

                                      
  //:

              
        obj.initdom   = function(){
        
              //root                              = $.$(rootnode,'filemod-root');
              shadow                            = host.shadowRoot;

              var style                         = $(shadow,'style'); 
              menu.add.style(shadow);
              $.stylesheet.insert(style,'button');


              localfile.initdom();
              github.initdom();
              fileserver.initdom();
              dbfiles.initdom();
              googlestorage.initdom();
              ftpserver.initdom(shadow);


              $(shadow,'#root').style.visibility    = '';

              
              export_icon_css();

              
        }//initdom
                    

  //:
  
          
        obj.save    = function(file){return save(file)}
          
        async function save(file){
                                                                                debug('save');
              if(!file){
                    if(!cur){
                          log.orange('no file');
                          return;
                    }
                    file    = cur;
              }
                                                                                console.log(file);
              
              var blob    = await source();
              
              switch(cur.type){
                
                case 'github'               : await github.save(cur,blob);              break;
                case 'localfile'            : await localfile.save(cur,blob);           break;
                case 'file-server'          : await fileserver.save(cur,blob);          break;
                case 'db-files'             : await dbfiles.save(cur,blob);             break;
                case 'google-storage'       : await googlestorage.save(cur,blob);       break;
                case 'ftp-server'           : await ftpserver.save(cur,blob);           break;
                
              }//switch
        
        }//save
                  
                  
        obj.clear   = function(){
          
              if(!cur){
                    return 'no file';
              }
              
              switch(cur.type){
                
                case 'github'           : github.clear();               break;
                case 'local'            : localfile.clear();            break;
                case 'file-server'      : fileserver.clear();           break;
                case 'db-files'         : dbfiles.clear();              break;
                case 'google-storage'   : googlestorage.clear();        break;
                case 'ftp-server'       : ftpserver.clear();            break;
                
              }//switch
              
              cur   = null;
              
        }//clear
                  

  //:
  
  
        obj.new       = newfile;
        obj.newfile   = newfile;

        
        function newfile({
        
              filetype,ft,
              
              abs,path,
              name,filename,
              rel,
              
              kind,
              size,
              ctime,mtime,
              
              title,icon
              
        }){
        
              var file          = {};
              
              file.filetype     = filetype||ft;
              file.ft           = filetype||ft;
              file.type         = filetype||ft;
              
              
              file.abs          = abs
              file.path         = path;
              file.name         = name||filename;
              file.filename     = name||filename;

              file.rel          = rel;              
              
              file.kind         = kind;
              file.size         = item.size;
              file.ctime        = ctime;
              file.mtime        = mtime;
              file.atime        = atime;

              file.title        = title;
              file.icon         = icon;
              
              return file;
              
        }//new
        
        
        obj.export    = function(){
        
              if(!cur){
                    return 'no file';
              }
              
              var file;
              var type    = cur.filetype||cur.type;
              
              switch(type){
                
                case 'github'           : file    = github.export(cur);               break;
                case 'local'            : return 'local';
                case 'file-server '     : file    = fileserver.export(cur);           break;
                case 'db-files'         : file    = dbfiles.export(cur);              break;
                case 'google-storage'   : file    = googlestorage.export(cur);        break;
                case 'ftp-server'       : file    = ftpserver.export(cur);            break;
                
              }//switch
              
              //file.filetype   = type;
              //file.type       = type;
              
              return file;
              
        }//export
                  
                  
        obj.import    = function(file){
          
        }//import



  //:
  
  
        function export_icon_css(){
          
              var style   = $(shadow,'style');
                                                                                console.log(style);
              var sheet   = style.sheet;
              var rules   = sheet.cssRules;
                                                                                console.log(rules);
              var rule    = [...rules].find(rule=>rule.selectorText=='.icon');
                                                                                console.log(rule);
              var css     = rule.cssText;
              var style   = document.createElement('style');
              style.textContent   = css;
              document.head.append(style);
              
        }//export_icon_css
        
        
  //:
  
  
        function debug(){
        
              if(!df)return;  
              var str   = [...arguments].join(' ');
              console.log('[ file-mod ]',str);
              
        }//debug
        
        
  return obj;
  
});//filemod

            
      </script>

</file-mod>


