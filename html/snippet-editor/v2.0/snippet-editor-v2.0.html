


<snippet-editor v2.0>


      <template shadowrootmode=open>
      
            <style>
            
  #root
    {display:flex;flex-direction:column;gap:10px;border:1px solid lightgray;padding:10px;border-radius:5px;
      /*height:100%*/
    }
    
  input
    {font-size:16px;padding:5px 10px}
  input[type=button]
    {cursor:pointer}
    
    
            </style>
            
            <div id=root>
            
                  <div>
                        <file-mod component></file-mod>
                  </div>
                  
                  <web-editor component v2.0></web-editor>
                  
            </div>
            
      </template>
      
      
      <script>
      
      
(function snippet_editor({mod,dom,host}){

  var obj   = {
        version   : 'v2.0',
  };
  
        var df=true,did='snippet-editor'
        ;
        
        
        var ext,$,menu,ace,menumod,log,config={},github
        ;
        
        obj.initmod   = function(params){
        
              ext             = mod.rd(params,'ext',ext);
              $               = mod.rd(params,'$',$);
              menu            = mod.rd(params,'menu',menu);
              ace             = mod.rd(params,'ace',ace);
              menumod         = mod.rd(params,'menumod',menumod);
              log             = mod.rd(params,'log',log);
              config          = mod.rd(params,'config',config,{});
              github          = mod.rd(params,'github',github);
              
        }//initmod
        
        
  //:
  
  
        var config              = {};
        config['web-editor']    = {fullsize:true};
        
        
        var target;
        
        var filemod;
        obj.filemod   = null;
        var editor;
        obj.editor    = null;
        
        var def   = {};
        
        var src;
        
        
        var rd    = {};
        rd.attr   = {};
        
        
  //:
  
  
        obj.init    = async function(){
                                                                                debug('init',obj.version);
                                                                                
              var dom_config          = mod.rd.config(dom);
              config                  = Object.assign(config,dom_config);
              
              config['web-editor']    = mod.rd.attr(dom,'web-editor',config);
              
              
              if(!('fullsize' in config['web-editor'])){
                    config['web-editor'].fullsize    = true;
              }
                                                                                debug('config',config);
                                                                                
              target        = dom;
              
              
              def.txt       = $.htmlentities.decode(target);
              
              
              var mode      = rd.attr.mode();
              if(mode){
                    config['web-editor'].mode   = mode;
              }
              
              
              filemod         = mod['file-mod'];
              obj.filemod     = filemod;
              editor          = mod['web-editor'];
              obj.editor      = editor;
              
              
              filemod.initmod({ext,$,menu,menumod,complete,source});
              editor.initmod({ext,$,menu,menumod,ace,config:config['web-editor']});
              
              await Promise.all([
                    rd.attr.src(),
                    filemod.init(),
                    editor.init(),
              ]);
              
              
        }//init
        
        
        rd.attr.src    = async function(){
        
              if(!target.hasAttribute('src'))return;
              src       = target.getAttribute('src');
                                                                                debug('src',src);
              if(src.startsWith('github:')){
                    await load_github(src);
                    return;
              }
              
              var err;
              try{
              
                    var res   = await fetch(src);
                    
              }//try
              catch(err2){
              
                    err   = err2;
                    
              }//catch
              if(err){
                                                                                console.log(err);
                    var error   = err.toString();
                    def.txt     = error;
                    return;
              }
              if(!res.ok){
                    var error   = res.status+' : '+res.statusText;
                    def.txt     = error;
                    return;
              }
              
              var txt   = await res.text();
              def.txt   = txt;
              
        }//src
        
        
        async function load_github(src){
        
              if(!github){
                    [github]    = await ext.load.libs('js/io/github/github.js');
              }
              
              var [a,owner,repo,branch,path]    = src.split(':');
              
              var {txt,error}   = await github.file.load.text({owner,repo,branch,path});
              if(error){
                                                                                console.log('error',error);
                    def.txt   = error;
                    return;
              }
              
              def.txt   = txt;
              
        }//load_github
        
        
        rd.attr.mode   = function(){
        
              if(!dom.hasAttribute('mode'))return;
              def.mode    = dom.getAttribute('mode');
              return def.mode;
              
        }//mode
        
        
        rd.fullsize   = function(){
        
              if(!dom.hasAttribute('fullsize'))return;
              def.fullsize    = true;
              return true;
              
        }//fullsize
        
        
  //:
  
  
        obj.initdom    = function(){
                                                                                debug('initdom');
              var shadow                          = host.shadowRoot;
              
              filemod.initdom();
              editor.initdom({txt:def.txt});
              editor.filename(src);
              
        }//initdom
        
        
  //:
  
  
        function source(){
        
              var txt     = editor.getvalue();
              var blob    = new Blob([txt]);
              return blob;
              
        }//source
        
        
        function complete(file){
        }//complete
        
        
        complete.load   = function(file,blob){
        }//load
        
        
        complete.save   = function(file){
        
              (log||window.log)?.green(file.name+' saved');
              
        }//save
        
        
  //:
  
  
        function debug(...args){
        
              if(!df && !obj.df)return;
              args.unshift(`[ ${did} ]`);
              var fmt     = Array.from({length:args.length}).fill('%O').join(' ');
              var args2   = [fmt].concat(args);
              console.groupCollapsed.apply(console,args2);
              console.trace();
              console.groupEnd();
              
        }//debug
        
        
        
  return obj;
  
//snippet_editor
})

      </script>
      
      
</snippet-editor>